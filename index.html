<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PropFlow</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700;800&display=swap');

:root {
  --ink: #0F172A;
  --paper: #F8FAFC;
  --surface: #FFFFFF;
  --border: #E2E8F0;
  --muted: #94A3B8;
  --icon: #374151;
  --icon-muted: #9CA3AF;
  --blue: #2563EB;
  --blue-lt: #EFF6FF;
  --green: #059669;
  --green-lt: #ECFDF5;
  --amber: #D97706;
  --amber-lt: #FFFBEB;
  --red: #DC2626;
  --red-lt: #FEF2F2;
  --purple: #7C3AED;
  --purple-lt: #F5F3FF;
  --r: 14px; --rs: 10px;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'IBM Plex Sans Arabic', sans-serif;
  background: #F1F5F9;
  display: flex; justify-content: center; align-items: flex-start;
  min-height: 100dvh; direction: rtl;
}

/* Desktop wrapper â€” centers the app in a 420px column */
.shell {
  width: 420px;
  min-height: 100dvh;
  background: transparent;
  position: relative;
  display: flex;
  flex-direction: column;
}

.island { display: none; }

.screen {
  background: var(--paper);
  flex: 1;
  overflow: hidden;
  position: relative;
  min-height: 100dvh;
  box-shadow: 0 0 0 1px var(--border), 0 8px 40px rgba(0,0,0,0.10);
}

/* VIEWS */
.view {
  position: absolute; inset: 0; overflow-y: auto; overflow-x: hidden;
  background: var(--paper); padding-bottom: calc(78px + env(safe-area-inset-bottom, 0px));
  transition: transform .3s cubic-bezier(.4,0,.2,1), opacity .3s ease;
  -webkit-overflow-scrolling: touch;
}
.view.hidden { transform: translateX(-20px); opacity: 0; pointer-events: none; }
.view.hidden.from-right { transform: translateX(20px); }
.view::-webkit-scrollbar { display: none; }

/* STATUS BAR */
.sbar {
  display: flex; justify-content: space-between; align-items: center;
  padding: 14px 22px 6px; font-size: 13px; font-weight: 600;
  background: var(--surface); position: sticky; top: 0; z-index: 50;
}
.sbar-icons { display: flex; gap: 6px; align-items: center; }

/* NAV BAR */
.nav {
  position: fixed; bottom: 0;
  width: 420px;
  background: rgba(255,255,255,.97); backdrop-filter: blur(24px);
  border-top: 1px solid var(--border);
  display: flex; justify-content: space-around;
  padding: 10px 4px calc(10px + env(safe-area-inset-bottom, 0px)); z-index: 100;
}
.nb {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  border: none; background: none; cursor: pointer; padding: 4px 12px;
  font-family: inherit; transition: transform .1s;
}
.nb:active { transform: scale(.88); }
.nb svg { width: 24px; height: 24px; stroke: var(--icon-muted); stroke-width: 1.6; fill: none; transition: stroke .15s; }
.nb.on svg { stroke: var(--blue); }
.nb-label { font-size: 9px; font-weight: 600; color: var(--muted); transition: color .15s; }
.nb.on .nb-label { color: var(--blue); }

/* SVG icon helper */
svg.ico { fill: none; stroke: var(--icon); stroke-width: 1.7; stroke-linecap: round; stroke-linejoin: round; }
svg.ico-sm { width: 16px; height: 16px; }
svg.ico-md { width: 20px; height: 20px; }
svg.ico-lg { width: 24px; height: 24px; }

/* Unit type icon containers */
.unit-ico {
  width: 42px; height: 42px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.unit-ico svg { width: 22px; height: 22px; fill: none; stroke-width: 1.7; stroke-linecap: round; stroke-linejoin: round; }
.ui-apt    { background: var(--blue-lt);   } .ui-apt    svg { stroke: var(--blue);   }
.ui-villa  { background: var(--green-lt);  } .ui-villa  svg { stroke: var(--green);  }
.ui-shop   { background: var(--amber-lt);  } .ui-shop   svg { stroke: var(--amber);  }
.ui-office { background: var(--purple-lt); } .ui-office svg { stroke: var(--purple); }

/* SHARED */
.card { background: var(--surface); border-radius: var(--r); border: 1.5px solid var(--border); overflow: hidden; }
.tbar { padding: 12px 18px 8px; display: flex; justify-content: space-between; align-items: center; }
.ttitle { font-size: 22px; font-weight: 800; letter-spacing: -.5px; }
.btn { display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; border: none; font-family: inherit; font-weight: 700; transition: transform .1s, opacity .1s; }
.btn:active { transform: scale(.95); opacity: .85; }
.btn-blue  { background: var(--blue);  color: #fff; padding: 13px 20px; border-radius: var(--rs); font-size: 15px; }
.btn-green { background: var(--green); color: #fff; padding: 13px 20px; border-radius: var(--rs); font-size: 15px; }
.btn-ghost { background: var(--blue-lt); color: var(--blue); padding: 13px 20px; border-radius: var(--rs); font-size: 14px; }
.btn-sm    { background: var(--blue); color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 13px; }
.btn-sm-amber { background: var(--amber); color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 13px; }
.fi { width: 100%; background: var(--surface); border: 1.5px solid var(--border); border-radius: var(--rs); padding: 11px 14px; font-size: 15px; font-family: inherit; color: var(--ink); outline: none; transition: border-color .15s; }
.fi:focus { border-color: var(--blue); }
.fi::placeholder { color: var(--muted); }
.fl { font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 5px; letter-spacing: .5px; text-transform: uppercase; }
.fg { margin-bottom: 12px; }
.li { display: flex; align-items: center; gap: 12px; padding: 13px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background .1s; }
.li:last-child { border-bottom: none; }
.li:active { background: var(--paper); }
.chip { padding: 8px 14px; border-radius: 20px; border: 1.5px solid var(--border); font-size: 13px; font-weight: 600; background: var(--surface); color: var(--ink); cursor: pointer; transition: all .15s; font-family: inherit; }
.chip.on { background: var(--blue); color: #fff; border-color: var(--blue); }
.chip:active { transform: scale(.95); }
.ftab { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; white-space: nowrap; cursor: pointer; border: 1.5px solid var(--border); background: var(--surface); color: var(--muted); transition: all .15s; font-family: inherit; }
.ftab.on { background: var(--blue); color: #fff; border-color: var(--blue); }
.sec-h { display: flex; justify-content: space-between; align-items: center; padding: 13px 16px 7px; }
.sec-ht { font-size: 15px; font-weight: 800; }
.sec-hl { font-size: 12px; color: var(--blue); font-weight: 700; cursor: pointer; }
.stag { display: inline-flex; align-items: center; gap: 4px; padding: 3px 9px; border-radius: 20px; font-size: 11px; font-weight: 700; white-space: nowrap; }
.hero { margin: 0 14px 14px; background: var(--blue); border-radius: 18px; padding: 20px; color: #fff; }
.srow { display: flex; gap: 10px; padding: 0 14px 14px; }
.sbox { flex: 1; border-radius: var(--rs); padding: 12px 8px; text-align: center; background: var(--surface); border: 1.5px solid var(--border); cursor: pointer; }
.snum { font-size: 22px; font-weight: 800; }
.slbl { font-size: 10px; color: var(--muted); margin-top: 3px; font-weight: 600; }
.asheet { margin: 10px 14px 14px; background: linear-gradient(140deg,#2563EB 0%,#1E3A8A 100%); border-radius: 20px; padding: 18px; box-shadow: 0 16px 48px rgba(37,99,235,.4); }
.tgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
.tbtn { border-radius: 14px; padding: 14px 10px; text-align: center; background: rgba(255,255,255,.14); color: #fff; font-size: 13px; font-weight: 700; cursor: pointer; border: 2px solid transparent; transition: all .15s; font-family: inherit; display: flex; flex-direction: column; align-items: center; gap: 5px; }
.tbtn svg { width: 24px; height: 24px; fill: none; stroke: rgba(255,255,255,.8); stroke-width: 1.7; stroke-linecap: round; stroke-linejoin: round; transition: stroke .15s; }
.tbtn.on { background: #fff; color: var(--blue); }
.tbtn.on svg { stroke: var(--blue); }
.tbtn:active { transform: scale(.94); }
.sfl { font-size: 10px; color: rgba(255,255,255,.7); margin-bottom: 4px; font-weight: 700; }
.sfi { background: #fff; border-radius: 10px; padding: 11px 12px; font-size: 15px; font-weight: 700; color: var(--ink); width: 100%; border: none; outline: none; font-family: inherit; }
.sbtn { background: #fff; color: var(--blue); border-radius: 12px; padding: 14px; text-align: center; font-size: 14px; font-weight: 800; cursor: pointer; border: none; width: 100%; font-family: inherit; }
.sbtn:active { transform: scale(.97); opacity: .9; }
.mnav { display: flex; align-items: center; gap: 8px; padding: 0 14px 14px; }
.mnav-btn { width: 40px; height: 40px; border-radius: 10px; background: var(--surface); border: 1.5px solid var(--border); cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-family: inherit; transition: all .15s; }
.mnav-btn:active { background: var(--paper); transform: scale(.92); }
.mdisp { flex: 1; background: var(--blue); color: #fff; border-radius: var(--rs); padding: 11px; text-align: center; font-size: 16px; font-weight: 800; }
.prow { display: flex; align-items: center; gap: 10px; padding: 13px 14px; border-bottom: 1px solid var(--border); }
.prow:last-child { border-bottom: none; }
.prog-wrap { padding: 0 14px 12px; }
.prog-head { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; font-weight: 600; }
.prog-track { height: 7px; background: var(--border); border-radius: 4px; overflow: hidden; }
.prog-fill { height: 100%; border-radius: 4px; transition: width .5s ease; }
.msum { display: flex; background: var(--surface); border: 1.5px solid var(--border); border-radius: var(--r); margin: 0 14px 12px; overflow: hidden; }
.msum-item { flex: 1; padding: 12px 6px; text-align: center; }
.msum-item + .msum-item { border-right: 1px solid var(--border); }
.msum-val { font-size: 17px; font-weight: 800; }
.msum-lbl { font-size: 9px; color: var(--muted); font-weight: 600; margin-top: 3px; }
.pay-toggle { flex-shrink: 0; border: none; cursor: pointer; font-family: inherit; padding: 9px 14px; border-radius: 20px; font-size: 12px; font-weight: 800; transition: all .2s; }
.pay-toggle:active { transform: scale(.92); }
.pt-paid    { background: var(--green-lt);  color: var(--green); }
.pt-unpaid  { background: var(--blue-lt);   color: var(--blue);  }
.pt-late    { background: var(--red-lt);    color: var(--red);   }
.pt-advance { background: var(--purple-lt); color: var(--purple);}
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 200; display: flex; align-items: flex-end; justify-content: center; opacity: 0; pointer-events: none; transition: opacity .3s; }
.overlay.open { opacity: 1; pointer-events: all; }
.msheet { background: var(--surface); border-radius: 24px 24px 0 0; width: 100%; max-width: 420px; padding: 20px 20px calc(34px + env(safe-area-inset-bottom, 0px)); transform: translateY(100%); transition: transform .35s cubic-bezier(.4,0,.2,1); max-height: 88%; overflow-y: auto; }
.overlay.open .msheet { transform: translateY(0); }
.mhandle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 18px; }
.mtitle { font-size: 18px; font-weight: 800; margin-bottom: 16px; }
.rep-card { margin: 0 14px 14px; background: var(--blue); color: #fff; border-radius: 18px; padding: 20px; }
.rep-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,.15); }
.rep-row:last-child { border-bottom: none; }
.rep-lbl { font-size: 13px; color: rgba(255,255,255,.8); }
.rep-val { font-size: 15px; font-weight: 800; }
.maint-row { padding: 13px 14px; border-bottom: 1px solid var(--border); cursor: pointer; }
.maint-row:last-child { border-bottom: none; }
.maint-row:active { background: var(--paper); }
.back-row { display: flex; align-items: center; gap: 10px; padding: 4px 0 12px; cursor: pointer; }
.toast { position: fixed; bottom: calc(90px + env(safe-area-inset-bottom, 0px)); left: 50%; transform: translateX(-50%) translateY(16px); background: var(--ink); color: #fff; padding: 11px 22px; border-radius: 30px; font-size: 14px; font-weight: 700; box-shadow: 0 8px 30px rgba(0,0,0,.35); opacity: 0; transition: all .28s; white-space: nowrap; z-index: 9999; pointer-events: none; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

@media (max-width: 420px) {
  body { background: var(--paper); align-items: flex-start; }
  .shell { width: 100%; min-height: 100dvh; }
  .screen { min-height: 100dvh; box-shadow: none; }
  .nav { width: 100%; }
  /* Safe area top for status bar area */
  .sbar { padding-top: max(14px, env(safe-area-inset-top, 14px)); }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="shell">
  <div class="island"></div>
  <div class="screen" id="app">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="view" id="v-home" style="background:var(--surface);">
      <div class="sbar">
        <span>9:41</span>
        <div class="sbar-icons">
          <!-- Signal -->
          <svg width="16" height="14" viewBox="0 0 16 14" fill="none"><rect x="0" y="8" width="3" height="6" rx="1" fill="#374151"/><rect x="4.5" y="5" width="3" height="9" rx="1" fill="#374151"/><rect x="9" y="2" width="3" height="12" rx="1" fill="#374151"/><rect x="13.5" y="0" width="2.5" height="14" rx="1" fill="#374151"/></svg>
          <!-- Battery -->
          <svg width="22" height="12" viewBox="0 0 22 12" fill="none"><rect x="0.5" y="0.5" width="18" height="11" rx="3" stroke="#374151" stroke-width="1.3"/><rect x="2" y="2" width="13" height="8" rx="1.5" fill="#374151"/><path d="M19.5 4v4a1.5 1.5 0 0 0 0-4z" fill="#374151"/></svg>
        </div>
      </div>
      <div class="tbar">
        <div>
          <div style="font-size:12px;color:var(--muted);">ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±ØŒ Ø£Ø­Ù…Ø¯ ğŸ‘‹</div>
          <div class="ttitle">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
        </div>
        <div style="width:38px;height:38px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;color:#fff;font-size:15px;font-weight:800;">Ø£</div>
      </div>

      <div class="hero" id="home-hero"></div>
      <div class="srow" id="home-stats"></div>

      <div class="sec-h">
        <div class="sec-ht">Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</div>
        <div class="sec-hl" onclick="go('properties')">Ø§Ù„ÙƒÙ„</div>
      </div>
      <div class="card" style="margin:0 14px 14px;" id="home-prop-list"></div>

      <div style="padding:0 14px 6px;">
        <button class="btn btn-blue" style="width:100%;gap:8px;" onclick="go('payments')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          ØªØ­ØµÙŠÙ„ Ø§Ù„Ø´Ù‡Ø±
        </button>
      </div>
      <div style="padding:4px 14px;">
        <button class="btn btn-ghost" style="width:100%;gap:8px;" onclick="go('maintenance')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
          Ø§Ù„ØµÙŠØ§Ù†Ø©
        </button>
      </div>
      <div style="height:14px;"></div>
    </div>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROPERTIES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="view hidden" id="v-properties">
      <div class="sbar"><span>9:41</span></div>
      <div class="tbar">
        <div class="ttitle">Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</div>
        <button class="btn btn-sm" onclick="openModal('m-add-prop')">+ Ø¥Ø¶Ø§ÙØ©</button>
      </div>
      <div style="padding:0 14px 12px; position:relative;">
        <svg style="position:absolute;right:26px;top:50%;transform:translateY(-50%);pointer-events:none;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="fi" style="padding-right:42px;" placeholder="Ø§Ø¨Ø­Ø«..." id="prop-q" oninput="renderProps()">
      </div>
      <div id="props-list"></div>
    </div>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROPERTY DETAIL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="view hidden from-right" id="v-prop-detail">
      <div class="sbar"><span>9:41</span></div>
      <div id="prop-detail-body"></div>
    </div>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAYMENTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="view hidden" id="v-payments">
      <div class="sbar"><span>9:41</span></div>
      <div class="tbar">
        <div class="ttitle">Ø§Ù„ØªØ­ØµÙŠÙ„</div>
        <div style="font-size:11px;color:var(--muted);">Ø§Ø¶ØºØ· Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©</div>
      </div>

      <div class="mnav">
        <button class="mnav-btn" onclick="shiftMonth(-1)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--icon)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
        <div class="mdisp" id="pay-month-lbl">â€”</div>
        <button class="mnav-btn" onclick="shiftMonth(1)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--icon)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
      </div>

      <div style="padding:0 14px 10px;">
        <select class="fi" id="pay-prop-sel" onchange="renderPayments()" style="cursor:pointer;"></select>
      </div>

      <div class="msum" id="pay-summary"></div>

      <div class="prog-wrap">
        <div class="prog-head">
          <span id="prog-txt">â€”</span>
          <span id="prog-pct" style="color:var(--green);font-weight:800;">â€”</span>
        </div>
        <div class="prog-track"><div class="prog-fill" id="prog-fill" style="background:var(--green);width:0%;"></div></div>
      </div>

      <div style="display:flex;gap:6px;padding:0 14px 12px;overflow-x:auto;" id="pay-tabs">
        <button class="ftab on" onclick="setPayFilter('all',this)">Ø§Ù„ÙƒÙ„</button>
        <button class="ftab" onclick="setPayFilter('unpaid',this)">Ù„Ù… ÙŠÙØ¯ÙØ¹</button>
        <button class="ftab" onclick="setPayFilter('paid',this)">Ù…Ø¯ÙÙˆØ¹</button>
        <button class="ftab" onclick="setPayFilter('late',this)">Ù…ØªØ£Ø®Ø±</button>
        <button class="ftab" onclick="setPayFilter('advance',this)">Ù…Ù‚Ø¯Ù‘Ù…</button>
      </div>

      <div class="card" style="margin:0 14px 12px;" id="pay-list"></div>

      <div style="padding:0 14px;">
        <button class="btn btn-green" style="width:100%;gap:8px;" onclick="toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­ØµÙŠÙ„')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
          Ø­ÙØ¸ Ø§Ù„ØªØ­ØµÙŠÙ„
        </button>
      </div>
      <div style="height:12px;"></div>
    </div>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAINTENANCE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="view hidden" id="v-maintenance">
      <div class="sbar"><span>9:41</span></div>
      <div class="tbar">
        <div class="ttitle">Ø§Ù„ØµÙŠØ§Ù†Ø©</div>
        <button class="btn btn-sm-amber btn" onclick="openAddMaintModal()">+ Ø·Ù„Ø¨</button>
      </div>
      <div class="srow" id="maint-stats"></div>
      <div style="display:flex;gap:6px;padding:0 14px 12px;overflow-x:auto;">
        <button class="ftab on" onclick="setMaintFilter('all',this)">Ø§Ù„ÙƒÙ„</button>
        <button class="ftab" onclick="setMaintFilter('open',this)">Ù…ÙØªÙˆØ­</button>
        <button class="ftab" onclick="setMaintFilter('progress',this)">Ø¬Ø§Ø±Ù</button>
        <button class="ftab" onclick="setMaintFilter('done',this)">Ù…ØºÙ„Ù‚</button>
      </div>
      <div class="card" style="margin:0 14px;" id="maint-list"></div>
    </div>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REPORTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="view hidden" id="v-reports">
      <div class="sbar"><span>9:41</span></div>
      <div class="tbar">
        <div class="ttitle">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
        <button class="btn btn-sm" onclick="shareReport()" style="display:flex;align-items:center;gap:5px;font-size:13px;">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
          Ù…Ø´Ø§Ø±ÙƒØ©
        </button>
      </div>
      <div class="mnav">
        <button class="mnav-btn" onclick="shiftRepMonth(-1)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--icon)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
        <div class="mdisp" id="rep-month-lbl">â€”</div>
        <button class="mnav-btn" onclick="shiftRepMonth(1)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--icon)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
      </div>
      <div class="rep-card" id="rep-summary"></div>
      <div class="sec-h"><div class="sec-ht">ØªÙ‚Ø±ÙŠØ± ÙƒÙ„ Ø¹Ù‚Ø§Ø±</div></div>
      <div id="rep-props" style="padding:0 14px;display:flex;flex-direction:column;gap:16px;padding-bottom:4px;"></div>
      <div style="padding:12px 14px 6px;">
        <button class="btn btn-blue" style="width:100%;gap:8px;font-size:14px;" onclick="shareReport()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
          Ù…Ø´Ø§Ø±ÙƒØ© ØªÙ‚Ø±ÙŠØ± PDF
        </button>
      </div>
      <div style="height:8px;"></div>
    </div>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REPORT PREVIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="view hidden from-right" id="v-report-preview" style="padding-bottom:0;z-index:150;">
      <!-- Sticky top bar -->
      <div style="position:sticky;top:0;z-index:200;background:var(--blue);padding:12px 16px;display:flex;align-items:center;gap:10px;">
        <button onclick="document.getElementById('v-report-preview').classList.add('hidden')"
          style="width:34px;height:34px;border-radius:9px;background:rgba(255,255,255,.2);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div style="flex:1;color:#fff;font-size:15px;font-weight:800;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>
        <button onclick="printReport()"
          style="background:#fff;color:var(--blue);border:none;border-radius:9px;padding:8px 16px;font-size:13px;font-weight:800;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Ø·Ø¨Ø§Ø¹Ø© / PDF
        </button>
      </div>
      <!-- Report content rendered here -->
      <div id="report-preview-content" style="padding:0;"></div>
    </div>

    <!-- â•â•â•â• NAV BAR â•â•â•â• -->
    <nav class="nav">
      <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <button class="nb on" id="nb-home" onclick="go('home')">
        <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <div class="nb-label">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </button>
      <!-- Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª -->
      <button class="nb" id="nb-properties" onclick="go('properties')">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
        <div class="nb-label">Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</div>
      </button>
      <!-- Ø§Ù„ØªØ­ØµÙŠÙ„ -->
      <button class="nb" id="nb-payments" onclick="go('payments')">
        <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        <div class="nb-label">Ø§Ù„ØªØ­ØµÙŠÙ„</div>
      </button>
      <!-- Ø§Ù„ØµÙŠØ§Ù†Ø© -->
      <button class="nb" id="nb-maintenance" onclick="go('maintenance')">
        <svg viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
        <div class="nb-label">Ø§Ù„ØµÙŠØ§Ù†Ø©</div>
      </button>
      <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
      <button class="nb" id="nb-reports" onclick="go('reports')">
        <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        <div class="nb-label">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
      </button>
    </nav>


    <!-- MODAL: ADD PROPERTY -->
    <div class="overlay" id="m-add-prop" onclick="closeOverlay('m-add-prop',event)">
      <div class="msheet">
        <div class="mhandle"></div>
        <div class="mtitle">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø±</div>
        <div class="fg"><div class="fl">Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±</div><input class="fi" id="np-name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø®ÙˆÙŠØ±"></div>
        <div class="fg"><div class="fl">Ø§Ù„Ù…Ø§Ù„Ùƒ</div><input class="fi" id="np-owner" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ"></div>
        <div class="fg" style="margin-bottom:20px;"><div class="fl">Ø§Ù„Ù…ÙˆÙ‚Ø¹</div><input class="fi" id="np-loc" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ù„Ø­ÙŠ"></div>
        <button class="btn btn-blue" style="width:100%;" onclick="addProperty()">Ø­ÙØ¸</button>
      </div>
    </div>

    <!-- MODAL: PAYMENT ENTRY -->
    <div class="overlay" id="m-pay-entry" onclick="closeOverlay('m-pay-entry',event)">
      <div class="msheet">
        <div class="mhandle"></div>
        <div id="m-pay-unit-header" style="background:var(--paper);border-radius:var(--rs);padding:12px;margin-bottom:16px;"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
          <div>
            <div class="fl">Ø§Ù„Ø­Ø§Ù„Ø©</div>
            <div style="display:flex;flex-direction:column;gap:6px;" id="m-pay-status-btns"></div>
          </div>
          <div>
            <div class="fl">Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)</div>
            <input class="fi" id="m-pay-amount" type="number" style="font-size:18px;font-weight:800;">
          </div>
        </div>
        <div class="fg" style="margin-bottom:20px;">
          <div class="fl">Ù…Ù„Ø§Ø­Ø¸Ø©</div>
          <input class="fi" id="m-pay-note" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ...">
        </div>
        <button class="btn btn-green" style="width:100%;font-size:15px;" onclick="savePayEntry()">Ø­ÙØ¸</button>
      </div>
    </div>

    <!-- MODAL: ADD MAINTENANCE -->
    <div class="overlay" id="m-add-maint" onclick="closeOverlay('m-add-maint',event)">
      <div class="msheet">
        <div class="mhandle"></div>
        <div class="mtitle" style="display:flex;align-items:center;gap:8px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--icon)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
          Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©
        </div>
        <div class="fg"><div class="fl">Ø§Ù„ÙˆØ­Ø¯Ø©</div><select class="fi" id="maint-unit-sel" style="cursor:pointer;"><option value="">Ø§Ø®ØªØ±...</option></select></div>
        <div class="fg">
          <div class="fl">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;" id="maint-type-grp">
            <button class="chip on" data-v="ÙƒÙ‡Ø±Ø¨Ø§Ø¡" onclick="chipSel(this,'maint-type-grp')">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</button>
            <button class="chip" data-v="Ø³Ø¨Ø§ÙƒØ©" onclick="chipSel(this,'maint-type-grp')">Ø³Ø¨Ø§ÙƒØ©</button>
            <button class="chip" data-v="ØªÙƒÙŠÙŠÙ" onclick="chipSel(this,'maint-type-grp')">ØªÙƒÙŠÙŠÙ</button>
            <button class="chip" data-v="Ø£Ø®Ø±Ù‰" onclick="chipSel(this,'maint-type-grp')">Ø£Ø®Ø±Ù‰</button>
          </div>
        </div>
        <div class="fg"><div class="fl">Ø§Ù„ÙˆØµÙ</div><input class="fi" id="maint-desc" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±..."></div>
        <div class="fg" style="margin-bottom:20px;"><div class="fl">Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„)</div><input class="fi" id="maint-cost" type="number" placeholder="0"></div>
        <button class="btn btn-blue" style="width:100%;background:var(--amber);" onclick="addMaint()">Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨</button>
      </div>
    </div>

    <!-- MODAL: EDIT UNIT -->
    <div class="overlay" id="m-edit-unit" onclick="closeOverlay('m-edit-unit',event)">
      <div class="msheet">
        <div class="mhandle"></div>
        <div class="mtitle" style="display:flex;align-items:center;gap:8px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--icon)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©
        </div>

        <!-- Unit type selector -->
        <div class="fg">
          <div class="fl">Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;" id="edit-type-grp">
            <button class="chip" data-t="apt"    onclick="editSelType(this)">Ø´Ù‚Ø©</button>
            <button class="chip" data-t="villa"  onclick="editSelType(this)">ÙÙŠÙ„Ø§</button>
            <button class="chip" data-t="shop"   onclick="editSelType(this)">Ù…Ø­Ù„</button>
            <button class="chip" data-t="office" onclick="editSelType(this)">Ù…ÙƒØªØ¨</button>
          </div>
        </div>

        <div class="fg">
          <div class="fl">Ø±Ù‚Ù… / Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</div>
          <input class="fi" id="edit-unit-num" placeholder="Ù…Ø«Ø§Ù„: Ø´Ù‚Ø© 3">
        </div>

        <div class="fg">
          <div class="fl">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±ÙŠØ§Ù„)</div>
          <input class="fi" id="edit-unit-rent" type="number" placeholder="0">
        </div>

        <!-- Status toggle -->
        <div class="fg" style="margin-bottom:20px;">
          <div class="fl">Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©</div>
          <div style="display:flex;gap:10px;margin-top:6px;">
            <button id="edit-st-rented" onclick="editSelSt('rented')" style="flex:1;border-radius:10px;padding:12px;font-size:14px;font-weight:800;cursor:pointer;border:2px solid var(--green);background:var(--green-lt);color:var(--green);font-family:inherit;transition:all .15s;">
              Ù…Ø¤Ø¬Ø±Ø©
            </button>
            <button id="edit-st-vacant" onclick="editSelSt('vacant')" style="flex:1;border-radius:10px;padding:12px;font-size:14px;font-weight:800;cursor:pointer;border:2px solid var(--border);background:var(--surface);color:var(--muted);font-family:inherit;transition:all .15s;">
              ÙØ§Ø¶ÙŠØ©
            </button>
          </div>
        </div>

        <!-- Tenant info -->
        <div class="fg" id="edit-tenant-wrap">
          <div class="fl">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</div>
          <input class="fi" id="edit-unit-tenant" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±">
        </div>
        <div class="fg" style="margin-bottom:20px;">
          <div class="fl" style="display:flex;justify-content:space-between;"><span>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span><span style="font-weight:400;letter-spacing:0;">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</span></div>
          <input class="fi" id="edit-unit-phone" type="tel" placeholder="05xxxxxxxx">
        </div>

        <button class="btn btn-blue" style="width:100%;font-size:15px;" onclick="saveEditUnit()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
      </div>
    </div>

    <!-- MODAL: QUICK LIST -->
    <div class="overlay" id="m-quicklist" onclick="closeOverlay('m-quicklist',event)">
      <div class="msheet">
        <div class="mhandle"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div class="mtitle" id="m-quicklist-title" style="margin-bottom:0;"></div>
          <button onclick="printQuickList()" style="display:flex;align-items:center;gap:5px;background:var(--blue);color:#fff;border:none;border-radius:8px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Ø·Ø¨Ø§Ø¹Ø© PDF
          </button>
        </div>
        <div id="m-quicklist-body"></div>
      </div>
    </div>

    <!-- MODAL: EDIT MAINTENANCE -->
    <div class="overlay" id="m-edit-maint" onclick="closeOverlay('m-edit-maint',event)">
      <div class="msheet">
        <div class="mhandle"></div>
        <div class="mtitle" style="display:flex;align-items:center;gap:8px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--icon)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø©
        </div>
        <div class="fg">
          <div class="fl">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;" id="edit-maint-type-grp">
            <button class="chip" data-v="ÙƒÙ‡Ø±Ø¨Ø§Ø¡" onclick="chipSel(this,'edit-maint-type-grp')">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</button>
            <button class="chip" data-v="Ø³Ø¨Ø§ÙƒØ©" onclick="chipSel(this,'edit-maint-type-grp')">Ø³Ø¨Ø§ÙƒØ©</button>
            <button class="chip" data-v="ØªÙƒÙŠÙŠÙ" onclick="chipSel(this,'edit-maint-type-grp')">ØªÙƒÙŠÙŠÙ</button>
            <button class="chip" data-v="Ø£Ø®Ø±Ù‰" onclick="chipSel(this,'edit-maint-type-grp')">Ø£Ø®Ø±Ù‰</button>
          </div>
        </div>
        <div class="fg"><div class="fl">Ø§Ù„ÙˆØµÙ</div><input class="fi" id="edit-maint-desc" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±..."></div>
        <div class="fg">
          <div class="fl">Ø§Ù„Ø­Ø§Ù„Ø©</div>
          <div style="display:flex;gap:8px;" id="edit-maint-st-grp">
            <button class="chip" data-v="open" onclick="chipSel(this,'edit-maint-st-grp')">Ù…ÙØªÙˆØ­</button>
            <button class="chip" data-v="progress" onclick="chipSel(this,'edit-maint-st-grp')">Ø¬Ø§Ø±Ù</button>
            <button class="chip" data-v="done" onclick="chipSel(this,'edit-maint-st-grp')">Ù…ØºÙ„Ù‚</button>
          </div>
        </div>
        <div class="fg" style="margin-bottom:20px;"><div class="fl">Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„)</div><input class="fi" id="edit-maint-cost" type="number" placeholder="0"></div>
        <button class="btn btn-blue" style="width:100%;font-size:15px;" onclick="saveEditMaint()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
      </div>
    </div>

    <!-- MODAL: CONFIRM DELETE -->
    <div class="overlay" id="m-confirm" onclick="closeOverlay('m-confirm',event)">
      <div class="msheet" style="padding-bottom:30px;">
        <div class="mhandle"></div>
        <div style="text-align:center;margin-bottom:14px;">
          <div style="width:52px;height:52px;background:var(--red-lt);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
          </div>
          <div id="m-confirm-title" style="font-size:18px;font-weight:800;margin-bottom:8px;"></div>
          <div id="m-confirm-body" style="font-size:14px;color:var(--muted);line-height:1.5;"></div>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;">
          <button onclick="closeModal('m-confirm')" style="flex:1;padding:13px;border-radius:var(--rs);border:1.5px solid var(--border);background:var(--surface);font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;">Ø¥Ù„ØºØ§Ø¡</button>
          <button id="m-confirm-ok" style="flex:1;padding:13px;border-radius:var(--rs);border:none;background:var(--red);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;">Ø­Ø°Ù</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toastEl"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SVG ICONS â€” outline, Ø±ØµØ§ØµÙŠ Ø¯Ø§ÙƒÙ†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SVG = {
  // Unit type icons
  apt: `<svg viewBox="0 0 24 24" fill="none" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9M15 21V9"/></svg>`,
  villa: `<svg viewBox="0 0 24 24" fill="none" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
  shop: `<svg viewBox="0 0 24 24" fill="none" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>`,
  office: `<svg viewBox="0 0 24 24" fill="none" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9M9 3v6M15 21V9"/></svg>`,

  // Nav & UI icons
  check: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
  arrow_left: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>`,
  arrow_right: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>`,

  // Maintenance type icons
  elec: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--icon)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
  pipe: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--icon)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22V12M12 12C12 7 17 4 17 4"/><path d="M7 8c0 4 5 4 5 8"/><circle cx="12" cy="22" r="0" fill="var(--icon)"/></svg>`,
  ac: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--icon)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="10" rx="2"/><line x1="2" y1="19" x2="22" y2="19"/><path d="M7 19v2M12 19v2M17 19v2"/></svg>`,
  wrench: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--icon)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>`,
};

const MAINT_ICO = { ÙƒÙ‡Ø±Ø¨Ø§Ø¡: SVG.elec, Ø³Ø¨Ø§ÙƒØ©: SVG.pipe, ØªÙƒÙŠÙŠÙ: SVG.ac, Ø£Ø®Ø±Ù‰: SVG.wrench };

// Unit type metadata
const TM = {
  apt:    { l:'Ø´Ù‚Ø©',  uicls:'ui-apt',    svg: SVG.apt    },
  villa:  { l:'ÙÙŠÙ„Ø§', uicls:'ui-villa',  svg: SVG.villa  },
  shop:   { l:'Ù…Ø­Ù„',  uicls:'ui-shop',   svg: SVG.shop   },
  office: { l:'Ù…ÙƒØªØ¨', uicls:'ui-office', svg: SVG.office },
};
function tm(t){ return TM[t]||TM.apt; }

// Unit icon HTML helper
function unitIco(type, size=42){
  const m=tm(type);
  return `<div class="unit-ico ${m.uicls}" style="width:${size}px;height:${size}px;border-radius:${size>36?12:10}px;">${m.svg}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE / MONTH HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS_AR=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
const now=new Date();
function mk(y,m){return`${y}-${String(m).padStart(2,'0')}`;}
function mkNow(){return mk(now.getFullYear(),now.getMonth()+1);}
function parseMk(k){const[y,m]=k.split('-');return{y:+y,m:+m};}
function fmtMk(k){const{y,m}=parseMk(k);return`${MONTHS_AR[m-1]} ${y}`;}
function prevMk(k){let{y,m}=parseMk(k);m--;if(m<1){m=12;y--;}return mk(y,m);}
function nextMk(k){let{y,m}=parseMk(k);m++;if(m>12){m=1;y++;}return mk(y,m);}
function fmt(n){return(+n||0).toLocaleString('ar-SA')+' Ø±ÙŠØ§Ù„';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const { createClient } = supabase;
const _sb = createClient('https://uiaapaudfwpjjuglvgpj.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpYWFwYXVkZndwamp1Z2x2Z3BqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MjE0MTEsImV4cCI6MjA4NzM5NzQxMX0.uvOBLyTisZJ0wbNSHKGmzP_s57V8jN3aSrKg2iVa21Y');

const DB={
  props:[], units:[], payments:{}, maint:[],
  nid:{prop:1,unit:1,maint:1},
  curMonth:mkNow(), repMonth:mkNow(),
  payFilter:'all', maintFilter:'all',
  activeProp:null, editPayUnit:null, editPayMonth:null,
};

// â”€â”€ Loading overlay â”€â”€
function showLoading(on){
  let el=document.getElementById('sb-loading');
  if(!el){
    el=document.createElement('div');
    el.id='sb-loading';
    el.style.cssText='position:fixed;inset:0;background:rgba(248,250,252,.95);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;font-family:IBM Plex Sans Arabic,sans-serif;';
    el.innerHTML='<div style="width:36px;height:36px;border:3px solid #E2E8F0;border-top-color:#2563EB;border-radius:50%;animation:sbspin .7s linear infinite;"></div><div style="font-size:14px;font-weight:600;color:#64748B;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div><style>@keyframes sbspin{to{transform:rotate(360deg)}}</style>';
    document.body.appendChild(el);
  }
  el.style.display=on?'flex':'none';
}

// â”€â”€ Load all data from Supabase â”€â”€
async function sbLoad(){
  showLoading(true);
  try {
    const [pr,ur,pymr,mr] = await Promise.all([
      _sb.from('props').select('*').order('id'),
      _sb.from('units').select('*').order('id'),
      _sb.from('payments').select('*'),
      _sb.from('maint').select('*').order('id'),
    ]);
    DB.props  = (pr.data||[]).map(r=>({...r}));
    DB.units  = (ur.data||[]).map(r=>({...r, pid:Number(r.pid), rent:Number(r.rent)}));
    DB.payments={};
    (pymr.data||[]).forEach(r=>{
      if(!DB.payments[r.unit_id]) DB.payments[r.unit_id]={};
      DB.payments[r.unit_id][r.month_key]={amount:Number(r.amount),note:r.note,paidAt:r.paid_at};
    });
    DB.maint=(mr.data||[]).map(r=>({...r,uid:Number(r.uid),pid:Number(r.pid),cost:Number(r.cost)}));
    if(DB.props.length)  DB.nid.prop  = Math.max(...DB.props.map(x=>x.id))+1;
    if(DB.units.length)  DB.nid.unit  = Math.max(...DB.units.map(x=>x.id))+1;
    if(DB.maint.length)  DB.nid.maint = Math.max(...DB.maint.map(x=>x.id))+1;
  } catch(e){ console.error(e); toast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); }
  showLoading(false);
}

// â”€â”€ Supabase CRUD helpers â”€â”€
async function sbAddProp(p){
  const {data,error}=await _sb.from('props').insert({name:p.name,owner:p.owner,loc:p.loc}).select().single();
  if(error){toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸');return null;} return data;
}
async function sbUpdateProp(p){
  await _sb.from('props').update({name:p.name,owner:p.owner,loc:p.loc}).eq('id',p.id);
}
async function sbDeleteProp(id){
  await _sb.from('props').delete().eq('id',id);
}
async function sbAddUnit(u){
  const {data,error}=await _sb.from('units').insert({pid:u.pid,type:u.type,num:u.num,rent:u.rent,st:u.st,tenant:u.tenant||'',phone:u.phone||''}).select().single();
  if(error){toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸');return null;} return data;
}
async function sbUpdateUnit(u){
  await _sb.from('units').update({type:u.type,num:u.num,rent:u.rent,st:u.st,tenant:u.tenant||'',phone:u.phone||''}).eq('id',u.id);
}
async function sbDeleteUnit(id){
  await _sb.from('units').delete().eq('id',id);
}
async function sbUpsertPayment(unitId,monthKey,rec){
  await _sb.from('payments').upsert({unit_id:unitId,month_key:monthKey,amount:rec.amount,note:rec.note||'',paid_at:rec.paidAt||''},{onConflict:'unit_id,month_key'});
}
async function sbDeletePayment(unitId,monthKey){
  await _sb.from('payments').delete().eq('unit_id',unitId).eq('month_key',monthKey);
}
async function sbAddMaint(m){
  const {data,error}=await _sb.from('maint').insert({uid:m.uid,pid:m.pid,type:m.type,description:m.descriptionription,cost:m.cost,st:m.st,dt:m.dt}).select().single();
  if(error){toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸');return null;} return data;
}
async function sbUpdateMaint(m){
  await _sb.from('maint').update({type:m.type,description:m.descriptionription,cost:m.cost,st:m.st,dt:m.dt}).eq('id',m.id);
}
async function sbDeleteMaint(id){
  await _sb.from('maint').delete().eq('id',id);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYMENT STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function payStatus(unit,monthKey){
  if(unit.st==='vacant') return 'vacant';
  const rec=DB.payments[unit.id]?.[monthKey];
  if(!rec){
    const{y,m}=parseMk(monthKey);
    if(new Date(y,m,0)<new Date()) return 'late';
    return 'unpaid';
  }
  const{y,m}=parseMk(monthKey);
  if(new Date(rec.paidAt)<new Date(y,m-1,1)) return 'advance';
  return 'paid';
}

const STATUS_META={
  paid:    {label:'Ù…Ø¯ÙÙˆØ¹',    style:'background:var(--green-lt);color:var(--green)'},
  advance: {label:'Ù…Ù‚Ø¯Ù‘Ù…',    style:'background:var(--purple-lt);color:var(--purple)'},
  late:    {label:'Ù…ØªØ£Ø®Ø±',   style:'background:var(--red-lt);color:var(--red)'},
  unpaid:  {label:'Ù„Ù… ÙŠÙØ¯ÙØ¹', style:'background:var(--blue-lt);color:var(--blue)'},
  vacant:  {label:'ÙØ§Ø¶ÙŠØ©',   style:'background:#F1F5F9;color:var(--muted)'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS=['home','properties','payments','maintenance','reports'];
function go(tab){
  document.getElementById('v-prop-detail').classList.add('hidden');
  TABS.forEach(t=>{
    document.getElementById('v-'+t).classList.add('hidden');
    const nb=document.getElementById('nb-'+t);
    if(nb) nb.classList.remove('on');
  });
  document.getElementById('v-'+tab).classList.remove('hidden');
  const nb=document.getElementById('nb-'+tab);
  if(nb) nb.classList.add('on');
  if(tab==='home')        renderHome();
  if(tab==='properties')  renderProps();
  if(tab==='payments')    renderPayments();
  if(tab==='maintenance') renderMaint();
  if(tab==='reports')     renderReports();
}
function openPropDetail(pid){
  DB.activeProp=pid;
  renderPropDetail(pid);
  document.getElementById('v-prop-detail').classList.remove('hidden');
}
function closePropDetail(){ document.getElementById('v-prop-detail').classList.add('hidden'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome(){
  const mk2=DB.curMonth;
  const ru=DB.units.filter(u=>u.st==='rented');
  let total=0,paid=0,late=0,advance=0,unpaid=0;
  ru.forEach(u=>{
    const s=payStatus(u,mk2),rec=DB.payments[u.id]?.[mk2];
    if(s==='paid')   {paid++;   total+=rec?.amount||0;}
    if(s==='advance'){advance++;total+=rec?.amount||0;}
    if(s==='late')   late++;
    if(s==='unpaid') unpaid++;
  });
  const comm=Math.round(total*.05);
  const totalRented=ru.length;
  const totalProps=DB.props.length;
  const unpaidUnits=DB.units.filter(u=>u.st==='rented'&&['late','unpaid'].includes(payStatus(u,mk2)));
  const vacantUnits=DB.units.filter(u=>u.st==='vacant');

  // Hero card (blue)
  document.getElementById('home-hero').innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;">
      <div style="font-size:11px;color:rgba(255,255,255,.75);">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
      <div style="font-size:12px;font-weight:800;color:#fff;">${fmtMk(mk2)}</div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:16px;">
      <div>
        <div style="font-size:11px;color:rgba(255,255,255,.75);margin-bottom:4px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</div>
        <div style="font-size:26px;font-weight:800;letter-spacing:-1px;">${(+total||0).toLocaleString('ar-SA')} Ø±</div>
      </div>
      <div style="text-align:left;">
        <div style="font-size:11px;color:rgba(255,255,255,.75);margin-bottom:4px;">Ø¹Ù…ÙˆÙ„ØªÙŠ 5%</div>
        <div style="font-size:20px;font-weight:800;color:#FBBF24;">${(+comm||0).toLocaleString('ar-SA')} Ø±</div>
      </div>
    </div>
    <div style="display:flex;gap:0;border-top:1px solid rgba(255,255,255,.2);padding-top:12px;">
      <div style="flex:1;text-align:center;">
        <div style="font-size:18px;font-weight:800;">${late+unpaid}</div>
        <div style="font-size:10px;color:rgba(255,255,255,.75);margin-top:2px;">Ù…ØªØ£Ø®Ø±Ø©</div>
      </div>
      <div style="width:1px;background:rgba(255,255,255,.2);"></div>
      <div style="flex:1;text-align:center;">
        <div style="font-size:18px;font-weight:800;">${totalRented}</div>
        <div style="font-size:10px;color:rgba(255,255,255,.75);margin-top:2px;">ÙˆØ­Ø¯Ø© Ù…Ø¤Ø¬Ø±Ø©</div>
      </div>
      <div style="width:1px;background:rgba(255,255,255,.2);"></div>
      <div style="flex:1;text-align:center;">
        <div style="font-size:18px;font-weight:800;">${totalProps}</div>
        <div style="font-size:10px;color:rgba(255,255,255,.75);margin-top:2px;">Ø¹Ù‚Ø§Ø±</div>
      </div>
    </div>`;

  // Stats row â€” 3 clickable cards matching reference image
  document.getElementById('home-stats').innerHTML=`
    <div class="sbox" onclick="showQuickList('unpaid')" style="border-color:var(--red-lt);">
      <div class="snum" style="color:var(--red);">${unpaidUnits.length}</div>
      <div class="slbl">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</div>
    </div>
    <div class="sbox" onclick="showQuickList('vacant')" style="border-color:var(--amber-lt);">
      <div class="snum" style="color:var(--amber);">${vacantUnits.length}</div>
      <div class="slbl">ØºÙŠØ± Ù…Ø¤Ø¬Ø±Ø©</div>
    </div>
    <div class="sbox" onclick="go('properties')" style="border-color:var(--blue-lt);">
      <div class="snum" style="color:var(--blue);">${totalProps}</div>
      <div class="slbl">Ø¹Ù‚Ø§Ø±</div>
    </div>`;

  // Property list â€” reference image style
  document.getElementById('home-prop-list').innerHTML=DB.props.map(p=>{
    const units=DB.units.filter(u=>u.pid===p.id);
    const rented=units.filter(u=>u.st==='rented');
    const lateC=rented.filter(u=>['late','unpaid'].includes(payStatus(u,mk2))).length;
    const collectedAmt=rented.reduce((s,u)=>{
      const rec=DB.payments[u.id]?.[mk2];
      return ['paid','advance'].includes(payStatus(u,mk2))?s+(rec?.amount||0):s;
    },0);
    const types=[...new Set(units.map(u=>u.type))];
    const icoStack=types.slice(0,2).map(t=>`<div class="unit-ico ${tm(t).uicls}" style="width:34px;height:34px;border-radius:9px;">${tm(t).svg}</div>`).join('');
    const statusTag=lateC>0
      ?`<span class="stag" style="background:var(--red-lt);color:var(--red);">${lateC} Ù…ØªØ£Ø®Ø±Ø©</span>`
      :`<span class="stag" style="background:var(--green-lt);color:var(--green);">Ù…ÙƒØªÙ…Ù„</span>`;
    return `<div class="li" onclick="openPropDetail(${p.id})" style="padding:12px 14px;">
      <div style="display:flex;gap:4px;">${icoStack}</div>
      <div style="flex:1;">
        <div style="font-size:14px;font-weight:700;">${p.name}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">${rented.length} ÙˆØ­Ø¯Ø© Â· ${p.loc}</div>
      </div>
      <div style="text-align:left;">
        <div style="font-size:13px;font-weight:800;color:var(--green);">${collectedAmt.toLocaleString('ar-SA')} Ø±</div>
        <div style="margin-top:3px;">${statusTag}</div>
      </div>
    </div>`;
  }).join('');
}

// Quick list modal popup
function showQuickList(type){
  const mk2=DB.curMonth;
  let units,title,emptyMsg;
  if(type==='unpaid'){
    units=DB.units.filter(u=>u.st==='rented'&&['late','unpaid'].includes(payStatus(u,mk2)));
    title='Ø§Ù„ÙˆØ­Ø¯Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©';
    emptyMsg='ÙƒÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©';
  } else {
    units=DB.units.filter(u=>u.st==='vacant');
    title='Ø§Ù„ÙˆØ­Ø¯Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©';
    emptyMsg='Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙØ§Ø¶ÙŠØ©';
  }
  document.getElementById('m-quicklist-title').textContent=title;
  document.getElementById('m-quicklist-body').innerHTML=units.length
    ?units.map(u=>{
        const p=DB.props.find(x=>x.id===u.pid);
        const s=type==='unpaid'?payStatus(u,mk2):'vacant';
        const tagMap={
          late:   {label:'Ù…ØªØ£Ø®Ø±',   bg:'var(--red-lt)',    c:'var(--red)'},
          unpaid: {label:'Ù„Ù… ÙŠÙØ¯ÙØ¹',bg:'var(--blue-lt)',   c:'var(--blue)'},
          vacant: {label:'ÙØ§Ø¶ÙŠØ©',   bg:'var(--paper)',     c:'var(--muted)'},
        };
        const sm=tagMap[s]||tagMap.vacant;
        return `<div style="display:flex;align-items:center;gap:10px;padding:11px 0;border-bottom:1px solid var(--border);" onclick="${type==='unpaid'?`go('payments')`:`openPropDetail(${u.pid})`};closeModal('m-quicklist');">
          ${unitIco(u.type,38)}
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:700;">${u.num}</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px;">${p?.name||''}</div>
          </div>
          <div style="text-align:left;">
            <span class="stag" style="background:${sm.bg};color:${sm.c};">${sm.label}</span>
            <div style="font-size:12px;font-weight:800;margin-top:3px;color:var(--ink);">${u.st==='vacant'?'â€”':fmt(u.rent)}</div>
          </div>
        </div>`;
      }).join('')
    :`<div style="padding:30px;text-align:center;color:var(--muted);">${emptyMsg}</div>`;
  window._qlType=type;
  openModal('m-quicklist');
}

function printQuickList(){
  const mk2=DB.curMonth;
  const title=document.getElementById('m-quicklist-title').textContent;
  const rows=document.getElementById('m-quicklist-body').querySelectorAll('[style*="border-bottom"]');
  const typeMap={apt:'Ø´Ù‚Ø©',villa:'ÙÙŠÙ„Ø§',shop:'Ù…Ø­Ù„',office:'Ù…ÙƒØªØ¨'};

  // Rebuild data from DOM context (_qlType set in showQuickList)
  const isUnpaid=window._qlType==='unpaid';
  const units=isUnpaid
    ?DB.units.filter(u=>u.st==='rented'&&['late','unpaid'].includes(payStatus(u,mk2)))
    :DB.units.filter(u=>u.st==='vacant');

  const rowsHtml=units.map(u=>{
    const p=DB.props.find(x=>x.id===u.pid);
    const s=isUnpaid?payStatus(u,mk2):'vacant';
    const stLabel={late:'Ù…ØªØ£Ø®Ø±',unpaid:'Ù„Ù… ÙŠÙØ¯ÙØ¹',vacant:'ÙØ§Ø¶ÙŠØ©'}[s]||s;
    const stColor={late:'#DC2626',unpaid:'#2563EB',vacant:'#94A3B8'}[s]||'#94A3B8';
    const amt=u.st==='vacant'?'â€”':fmt(u.rent);
    return `<tr>
      <td style="padding:9px 12px;border-bottom:1px solid #F1F5F9;font-size:13px;font-weight:700;">${u.num}</td>
      <td style="padding:9px 12px;border-bottom:1px solid #F1F5F9;font-size:12px;color:#64748B;">${typeMap[u.type]||u.type}</td>
      <td style="padding:9px 12px;border-bottom:1px solid #F1F5F9;font-size:12px;color:#64748B;">${p?.name||'â€”'}</td>
      <td style="padding:9px 12px;border-bottom:1px solid #F1F5F9;font-size:12px;font-weight:700;color:${stColor};">${stLabel}</td>
      <td style="padding:9px 12px;border-bottom:1px solid #F1F5F9;font-size:13px;font-weight:800;text-align:left;">${amt}</td>
    </tr>`;
  }).join('');

  const html=`<!DOCTYPE html><html lang="ar" dir="rtl"><head>
  <meta charset="UTF-8"><title>${title}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700;800&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'IBM Plex Sans Arabic',Arial,sans-serif;direction:rtl;padding:28px;color:#0F172A;}
    @page{size:A4;margin:16mm;}
    @media print{body{padding:0;}}
  </style></head><body>
  <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:20px;padding-bottom:12px;border-bottom:3px solid #2563EB;">
    <div>
      <div style="font-size:22px;font-weight:800;color:#2563EB;">PropFlow</div>
      <div style="font-size:13px;color:#64748B;margin-top:3px;">${title} Â· ${fmtMk(mk2)}</div>
    </div>
    <div style="font-size:11px;color:#94A3B8;">${new Date().toLocaleDateString('ar-SA')}</div>
  </div>
  <div style="margin-bottom:14px;background:${isUnpaid?'#FEF2F2':'#FFFBEB'};border-radius:10px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;">
    <div style="font-size:14px;font-weight:800;color:${isUnpaid?'#DC2626':'#D97706'};">${title}</div>
    <div style="font-size:13px;font-weight:700;color:#64748B;">${units.length} ÙˆØ­Ø¯Ø©</div>
  </div>
  <table style="width:100%;border-collapse:collapse;border:1px solid #E2E8F0;border-radius:10px;overflow:hidden;">
    <thead><tr style="background:#2563EB;color:#fff;">
      <th style="padding:10px 12px;font-size:12px;font-weight:700;text-align:right;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
      <th style="padding:10px 12px;font-size:12px;font-weight:700;text-align:right;">Ø§Ù„Ù†ÙˆØ¹</th>
      <th style="padding:10px 12px;font-size:12px;font-weight:700;text-align:right;">Ø§Ù„Ø¹Ù‚Ø§Ø±</th>
      <th style="padding:10px 12px;font-size:12px;font-weight:700;text-align:right;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th style="padding:10px 12px;font-size:12px;font-weight:700;text-align:left;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
    </tr></thead>
    <tbody>${rowsHtml}</tbody>
  </table>
  <div style="margin-top:20px;font-size:10px;color:#94A3B8;text-align:center;">PropFlow Â· ${new Date().toLocaleString('ar-SA')}</div>
  <script>window.onload=function(){window.print();}<\/script>
  </body></html>`;

  window._reportHtml=html;
  document.getElementById('report-preview-content').innerHTML=`
    <div style="font-family:sans-serif;direction:rtl;padding:16px;">
      <h2 style="color:#2563EB;margin-bottom:16px;">${title}</h2>
      <table style="width:100%;border-collapse:collapse;">
        <thead><tr style="background:#2563EB;color:#fff;">
          <th style="padding:8px 10px;text-align:right;font-size:12px;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
          <th style="padding:8px 10px;text-align:right;font-size:12px;">Ø§Ù„Ø¹Ù‚Ø§Ø±</th>
          <th style="padding:8px 10px;text-align:right;font-size:12px;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th style="padding:8px 10px;text-align:left;font-size:12px;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
        </tr></thead>
        <tbody>${units.map(u=>{
          const p=DB.props.find(x=>x.id===u.pid);
          const s=isUnpaid?payStatus(u,mk2):'vacant';
          const stLabel={late:'Ù…ØªØ£Ø®Ø±',unpaid:'Ù„Ù… ÙŠÙØ¯ÙØ¹',vacant:'ÙØ§Ø¶ÙŠØ©'}[s]||s;
          const stColor={late:'#DC2626',unpaid:'#2563EB',vacant:'#94A3B8'}[s]||'#94A3B8';
          return `<tr style="border-bottom:1px solid #F1F5F9;">
            <td style="padding:9px 10px;font-size:13px;font-weight:700;">${u.num}</td>
            <td style="padding:9px 10px;font-size:12px;color:#64748B;">${p?.name||'â€”'}</td>
            <td style="padding:9px 10px;font-size:12px;font-weight:700;color:${stColor};">${stLabel}</td>
            <td style="padding:9px 10px;font-size:13px;font-weight:800;text-align:left;">${u.st==='vacant'?'â€”':fmt(u.rent)}</td>
          </tr>`;
        }).join('')}</tbody>
      </table>
    </div>`;
  closeModal('m-quicklist');
  document.getElementById('v-report-preview').classList.remove('hidden');
  document.getElementById('v-report-preview').scrollTop=0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROPERTIES LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProps(){
  const q=(document.getElementById('prop-q')?.value||'').toLowerCase();
  const ps=DB.props.filter(p=>p.name.includes(q)||p.owner.includes(q));
  document.getElementById('props-list').innerHTML=`<div class="card" style="margin:0 14px 14px;">`+ps.map(p=>{
    const units=DB.units.filter(u=>u.pid===p.id);
    const types=[...new Set(units.map(u=>u.type))];
    const icoStack=types.slice(0,3).map(t=>`<div class="unit-ico ${tm(t).uicls}" style="width:36px;height:36px;border-radius:10px;">${tm(t).svg}</div>`).join('');
    return `<div class="li">
      <div style="display:flex;align-items:center;gap:12px;flex:1;cursor:pointer;" onclick="openPropDetail(${p.id})">
        <div style="display:flex;gap:4px;">${icoStack}</div>
        <div style="flex:1;">
          <div style="font-size:14px;font-weight:700;">${p.name}</div>
          <div style="font-size:12px;color:var(--muted);margin-top:2px;">${p.owner} Â· ${units.length} ÙˆØ­Ø¯Ø© Â· ${p.loc}</div>
        </div>
        <div style="color:var(--muted);">${SVG.arrow_right}</div>
      </div>
      <button onclick="confirmDeleteProp(${p.id})" style="flex-shrink:0;margin-right:6px;width:34px;height:34px;border-radius:9px;background:var(--red-lt);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
      </button>
    </div>`;
  }).join('')+`</div>`;
}

function confirmDeleteProp(pid){
  const p=DB.props.find(x=>x.id===pid);
  const n=DB.units.filter(u=>u.pid===pid).length;
  document.getElementById('m-confirm-title').textContent='Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±';
  document.getElementById('m-confirm-body').textContent=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${p.name}"${n>0?` Ùˆ${n} ÙˆØ­Ø¯Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡`:''}ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.`;
  document.getElementById('m-confirm-ok').onclick=()=>deleteProp(pid);
  openModal('m-confirm');
}
async function deleteProp(pid){
  await sbDeleteProp(pid);
  DB.props=DB.props.filter(p=>p.id!==pid);
  const uids=DB.units.filter(u=>u.pid===pid).map(u=>u.id);
  DB.units=DB.units.filter(u=>u.pid!==pid);
  uids.forEach(uid=>{delete DB.payments[uid];});
  closeModal('m-confirm');
  renderProps(); renderHome();
  toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø±');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROPERTY DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selType='apt', selSt='rented';

function renderPropDetail(pid){
  const p=DB.props.find(x=>x.id===pid);
  const units=DB.units.filter(u=>u.pid===pid);
  const ru=units.filter(u=>u.st==='rented');
  const typeCts={};
  units.forEach(u=>{typeCts[u.type]=(typeCts[u.type]||0)+1;});
  const legend=Object.entries(typeCts).map(([t,c])=>`
    <span style="display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(255,255,255,0.12);color:rgba(255,255,255,0.9);">
      <span style="width:14px;height:14px;display:inline-flex;">${TM[t]?.svg||''}</span> ${tm(t).l} Ã—${c}
    </span>`).join('');
  const totalRent=ru.reduce((s,u)=>s+u.rent,0);

  document.getElementById('prop-detail-body').innerHTML=`
    <div style="background:var(--ink);padding:14px 16px 16px;">
      <div class="back-row" onclick="closePropDetail()">
        ${SVG.arrow_left}
        <div>
          <div style="font-size:17px;font-weight:800;color:#fff;">${p.name}</div>
          <div style="font-size:11px;color:rgba(255,255,255,.6);">${p.owner} Â· ${p.loc}</div>
        </div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">${legend}</div>
    </div>

    <div style="display:flex;background:var(--surface);border-bottom:1px solid var(--border);margin-bottom:12px;">
      <div style="flex:1;padding:12px;text-align:center;border-left:1px solid var(--border);">
        <div style="font-size:18px;font-weight:800;color:var(--green);">${fmt(totalRent)}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:600;margin-top:2px;">Ø¥ÙŠØ¬Ø§Ø± Ø´Ù‡Ø±ÙŠ</div>
      </div>
      <div style="flex:1;padding:12px;text-align:center;border-left:1px solid var(--border);">
        <div style="font-size:18px;font-weight:800;">${ru.length}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:600;margin-top:2px;">Ù…Ø¤Ø¬Ø±Ø©</div>
      </div>
      <div style="flex:1;padding:12px;text-align:center;">
        <div style="font-size:18px;font-weight:800;">${units.length-ru.length}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:600;margin-top:2px;">ÙØ§Ø¶ÙŠØ©</div>
      </div>
    </div>

    <!-- Add Unit Sheet -->
    <div class="asheet">
      <div style="font-size:14px;font-weight:800;color:#fff;margin-bottom:14px;">Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø©</div>
      <div class="tgrid" id="detail-tgrid">
        <button class="tbtn on" data-t="apt"    onclick="selT(this)">${SVG.apt} Ø´Ù‚Ø©</button>
        <button class="tbtn"    data-t="villa"  onclick="selT(this)">${SVG.villa} ÙÙŠÙ„Ø§</button>
        <button class="tbtn"    data-t="shop"   onclick="selT(this)">${SVG.shop} Ù…Ø­Ù„</button>
        <button class="tbtn"    data-t="office" onclick="selT(this)">${SVG.office} Ù…ÙƒØªØ¨</button>
      </div>
      <div style="display:flex;gap:10px;margin-bottom:12px;">
        <div style="flex:1;"><div class="sfl">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</div><input class="sfi" id="unit-num" placeholder="${tm('apt').l} ${units.filter(u=>u.type==='apt').length+1}"></div>
        <div style="flex:1;"><div class="sfl">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±/Ø´Ù‡Ø±</div><input class="sfi" id="unit-rent" type="number" placeholder="0"></div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <button id="st-rented" onclick="selS('rented')" style="flex:1;border-radius:10px;padding:10px;font-size:13px;font-weight:800;cursor:pointer;border:none;font-family:inherit;background:#34D399;color:#fff;transition:all .15s;">Ù…Ø¤Ø¬Ø±Ø©</button>
        <button id="st-vacant" onclick="selS('vacant')" style="flex:1;border-radius:10px;padding:10px;font-size:13px;font-weight:800;cursor:pointer;border:none;font-family:inherit;background:rgba(255,255,255,.15);color:#fff;transition:all .15s;">ÙØ§Ø¶ÙŠØ©</button>
      </div>
      <div id="tenant-fields" style="margin-bottom:12px;transition:opacity .2s;">
        <div style="margin-bottom:10px;"><div class="sfl">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</div><input class="sfi" id="unit-tenant" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±"></div>
        <div><div class="sfl" style="display:flex;justify-content:space-between;"><span>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span><span style="opacity:.6;font-weight:400;">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</span></div><input class="sfi" id="unit-phone" type="tel" placeholder="05xxxxxxxx"></div>
      </div>
      <button class="sbtn" onclick="addUnit(${pid})">Ø­ÙØ¸ + Ø¥Ø¶Ø§ÙØ© Ø£Ø®Ø±Ù‰</button>
    </div>

    <div class="sec-h"><div class="sec-ht">Ø§Ù„ÙˆØ­Ø¯Ø§Øª (${units.length})</div></div>
    <div class="card" style="margin:0 14px 20px;" id="detail-units">${renderDetailUnits(pid)}</div>`;

  selType='apt'; selSt='rented';
}

function renderDetailUnits(pid){
  const units=DB.units.filter(u=>u.pid===pid);
  if(!units.length) return `<div style="padding:30px;text-align:center;color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª â€” Ø£Ø¶Ù Ø£ÙˆÙ„ ÙˆØ­Ø¯Ø© â†‘</div>`;
  const mk2=DB.curMonth;
  return units.map(u=>{
    const sm=STATUS_META[payStatus(u,mk2)];
    return `<div class="li" style="padding:11px 14px;">
      ${unitIco(u.type, 40)}
      <div style="flex:1;">
        <div style="font-size:14px;font-weight:700;">${u.num}</div>
        ${u.tenant?`<div style="font-size:12px;color:var(--ink);font-weight:600;margin-top:2px;">${u.tenant}${u.phone?' Â· '+u.phone:''}</div>`:''}
        <div style="margin-top:3px;"><span class="stag" style="${sm.style};">${sm.label}</span></div>
      </div>
      <div style="text-align:left;margin-left:8px;">
        <div style="font-size:13px;font-weight:800;">${u.st==='vacant'?'â€”':fmt(u.rent)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px;">${u.st==='rented'?'Ù…Ø¤Ø¬Ø±Ø©':'ÙØ§Ø¶ÙŠØ©'}</div>
      </div>
      <div style="display:flex;gap:5px;margin-right:4px;">
        <button onclick="openEditUnit(${u.id})" style="width:32px;height:32px;border-radius:8px;background:var(--blue-lt);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button onclick="confirmDeleteUnit(${u.id})" style="width:32px;height:32px;border-radius:8px;background:var(--red-lt);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
        </button>
      </div>
    </div>`;
  }).join('');
}

function confirmDeleteUnit(uid){
  const u=DB.units.find(x=>x.id===uid);
  document.getElementById('m-confirm-title').textContent='Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©';
  document.getElementById('m-confirm-body').textContent=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${u.num}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§.`;
  document.getElementById('m-confirm-ok').onclick=()=>deleteUnit(uid);
  openModal('m-confirm');
}
async function deleteUnit(uid){
  const u=DB.units.find(x=>x.id===uid);
  const pid=u.pid;
  await sbDeleteUnit(uid);
  DB.units=DB.units.filter(x=>x.id!==uid);
  delete DB.payments[uid];
  closeModal('m-confirm');
  renderPropDetail(pid);
  toast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©');
}

// â”€â”€ EDIT UNIT â”€â”€
let _editUid=null, _editSt='rented';

function openEditUnit(uid){
  const u=DB.units.find(x=>x.id===uid);
  _editUid=uid; _editSt=u.st;

  // Fill fields
  document.getElementById('edit-unit-num').value=u.num;
  document.getElementById('edit-unit-rent').value=u.rent||'';
  document.getElementById('edit-unit-tenant').value=u.tenant||'';
  document.getElementById('edit-unit-phone').value=u.phone||'';

  // Show/hide tenant fields
  const tw=document.getElementById('edit-tenant-wrap');
  if(tw){ tw.style.display=u.st==='rented'?'':'none'; }

  // Type chips
  document.querySelectorAll('#edit-type-grp .chip').forEach(c=>{
    c.classList.toggle('on', c.dataset.t===u.type);
  });

  // Status buttons
  _refreshEditStBtns(_editSt);

  openModal('m-edit-unit');
}

function editSelType(btn){
  document.querySelectorAll('#edit-type-grp .chip').forEach(c=>c.classList.remove('on'));
  btn.classList.add('on');
}

function editSelSt(s){
  _editSt=s;
  _refreshEditStBtns(s);
  const tw=document.getElementById('edit-tenant-wrap');
  if(tw){ tw.style.display=s==='rented'?'':'none'; }
}

function _refreshEditStBtns(s){
  const r=document.getElementById('edit-st-rented');
  const v=document.getElementById('edit-st-vacant');
  if(s==='rented'){
    r.style.background='var(--green-lt)'; r.style.color='var(--green)'; r.style.borderColor='var(--green)';
    v.style.background='var(--surface)';  v.style.color='var(--muted)'; v.style.borderColor='var(--border)';
  } else {
    v.style.background='#F1F5F9'; v.style.color='var(--ink)'; v.style.borderColor='var(--muted)';
    r.style.background='var(--surface)';  r.style.color='var(--muted)'; r.style.borderColor='var(--border)';
  }
}

async function saveEditUnit(){
  const u=DB.units.find(x=>x.id===_editUid);
  if(!u) return;

  const newNum=document.getElementById('edit-unit-num').value.trim();
  const newRent=parseInt(document.getElementById('edit-unit-rent').value)||0;
  const newType=document.querySelector('#edit-type-grp .chip.on')?.dataset.t||u.type;

  if(!newNum){ toast('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©'); return; }

  const newTenant=document.getElementById('edit-unit-tenant').value.trim();
  const newPhone=document.getElementById('edit-unit-phone').value.trim();
  if(_editSt==='rented'&&!newTenant){ toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'); return; }
  u.num=newNum; u.rent=newRent; u.type=newType; u.st=_editSt; u.tenant=newTenant; u.phone=newPhone;
  await sbUpdateUnit(u);
  closeModal('m-edit-unit');
  renderPropDetail(u.pid);
  toast('âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');
}

function selT(btn){
  btn.closest('#detail-tgrid').querySelectorAll('.tbtn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  selType=btn.dataset.t;
  const same=DB.units.filter(u=>u.pid===DB.activeProp&&u.type===selType);
  const numEl=document.getElementById('unit-num');
  numEl.placeholder=tm(selType).l+' '+(same.length+1);
  numEl.value='';
}
function selS(s){
  selSt=s;
  const r=document.getElementById('st-rented'),v=document.getElementById('st-vacant');
  r.style.background=s==='rented'?'#34D399':'rgba(255,255,255,.15)';
  r.style.color=s==='rented'?'#fff':'rgba(255,255,255,.6)';
  v.style.background=s==='vacant'?'rgba(255,255,255,.85)':'rgba(255,255,255,.15)';
  v.style.color=s==='vacant'?'var(--ink)':'rgba(255,255,255,.6)';
  const tf=document.getElementById('tenant-fields');
  if(tf){ tf.style.opacity=s==='rented'?'1':'0.4'; tf.style.pointerEvents=s==='rented'?'all':'none'; }
}
async function addUnit(pid){
  const numEl=document.getElementById('unit-num'),rentEl=document.getElementById('unit-rent');
  const tenantEl=document.getElementById('unit-tenant'),phoneEl=document.getElementById('unit-phone');
  const num=numEl.value.trim()||numEl.placeholder;
  const rent=parseInt(rentEl.value)||0;
  const tenant=tenantEl?tenantEl.value.trim():'';
  const phone=phoneEl?phoneEl.value.trim():'';
  if(!num){toast('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©');return;}
  if(selSt==='rented'&&!tenant){toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±');return;}
  const savedU=await sbAddUnit({pid,type:selType,num,rent,st:selSt,tenant:tenant||'',phone:phone||''});
  if(!savedU) return;
  DB.units.push({...savedU, pid:Number(savedU.pid), rent:Number(savedU.rent)});
  const same=DB.units.filter(u=>u.pid===pid&&u.type===selType);
  numEl.value=''; numEl.placeholder=tm(selType).l+' '+same.length; rentEl.value='';
  if(tenantEl) tenantEl.value='';
  if(phoneEl) phoneEl.value='';
  document.getElementById('detail-units').innerHTML=renderDetailUnits(pid);
  toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© '+num);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPayments(){
  document.getElementById('pay-month-lbl').textContent=fmtMk(DB.curMonth);
  const sel=document.getElementById('pay-prop-sel');
  const prev=sel.value;
  sel.innerHTML=`<option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</option>`+DB.props.map(p=>`<option value="${p.id}" ${prev==p.id?'selected':''}>${p.name}</option>`).join('');
  renderPayList();
}
function shiftMonth(dir){
  DB.curMonth=dir<0?prevMk(DB.curMonth):nextMk(DB.curMonth);
  renderPayments();
}
function renderPayList(){
  const mk2=DB.curMonth;
  const pidF=document.getElementById('pay-prop-sel')?.value||'all';
  let units=DB.units.filter(u=>u.st==='rented');
  if(pidF!=='all') units=units.filter(u=>u.pid===+pidF);

  let paidC=0,lateC=0,unpaidC=0,advC=0,colTotal=0;
  units.forEach(u=>{
    const s=payStatus(u,mk2),rec=DB.payments[u.id]?.[mk2];
    if(s==='paid')   {paidC++;   colTotal+=rec?.amount||0;}
    if(s==='advance'){advC++;    colTotal+=rec?.amount||0;}
    if(s==='late')   lateC++;
    if(s==='unpaid') unpaidC++;
  });
  const totalDue=units.reduce((s,u)=>s+u.rent,0);
  const pct=totalDue?Math.round(colTotal/totalDue*100):0;

  document.getElementById('pay-summary').innerHTML=`
    <div class="msum-item"><div class="msum-val" style="color:var(--green);">${paidC+advC}</div><div class="msum-lbl">Ù…Ø¯ÙÙˆØ¹</div></div>
    <div class="msum-item"><div class="msum-val" style="color:var(--red);">${lateC}</div><div class="msum-lbl">Ù…ØªØ£Ø®Ø±</div></div>
    <div class="msum-item"><div class="msum-val" style="color:var(--blue);">${unpaidC}</div><div class="msum-lbl">Ù„Ù… ÙŠÙØ¯ÙØ¹</div></div>
    <div class="msum-item"><div class="msum-val" style="color:var(--purple);">${advC}</div><div class="msum-lbl">Ù…Ù‚Ø¯Ù‘Ù…</div></div>
    <div class="msum-item"><div class="msum-val" style="font-size:13px;">${colTotal.toLocaleString('ar-SA')}</div><div class="msum-lbl">Ø±ÙŠØ§Ù„</div></div>`;

  document.getElementById('prog-txt').textContent=`${paidC+advC} Ù…Ù† ${units.length} ØªÙ… ØªØ­ØµÙŠÙ„Ù‡Ø§`;
  document.getElementById('prog-pct').textContent=`${pct}%`;
  document.getElementById('prog-pct').style.color=pct>=80?'var(--green)':pct>=50?'var(--amber)':'var(--red)';
  const pf=document.getElementById('prog-fill');
  pf.style.width=pct+'%';
  pf.style.background=pct>=80?'var(--green)':pct>=50?'var(--amber)':'var(--red)';

  const f=DB.payFilter;
  let shown=units;
  if(f!=='all') shown=units.filter(u=>payStatus(u,mk2)===f);

  if(!shown.length){
    document.getElementById('pay-list').innerHTML=`<div style="padding:28px;text-align:center;color:var(--muted);font-size:14px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ±</div>`;
    return;
  }

  document.getElementById('pay-list').innerHTML=shown.map(u=>{
    const prop=DB.props.find(p=>p.id===u.pid);
    const s=payStatus(u,mk2),sm=STATUS_META[s],rec=DB.payments[u.id]?.[mk2];
    let toggleCls='pay-toggle ',toggleLbl='';
    if(s==='paid')   {toggleCls+='pt-paid';   toggleLbl='Ù…Ø¯ÙÙˆØ¹';}
    if(s==='advance'){toggleCls+='pt-advance'; toggleLbl='Ù…Ù‚Ø¯Ù‘Ù…';}
    if(s==='late')   {toggleCls+='pt-late';    toggleLbl='ØªØ­ØµÙŠÙ„';}
    if(s==='unpaid') {toggleCls+='pt-unpaid';  toggleLbl='Ø¯ÙØ¹';}

    return `<div class="prow">
      ${unitIco(u.type, 38)}
      <div style="flex:1;min-width:0;">
        <div style="font-size:13px;font-weight:700;">${u.num}</div>
        <div style="display:flex;align-items:center;gap:6px;margin-top:3px;">
          <span class="stag" style="${sm.style};font-size:10px;padding:2px 8px;">${sm.label}</span>
          ${pidF==='all'?`<span style="font-size:11px;color:var(--muted);">${prop.name}</span>`:''}
        </div>
      </div>
      <div style="text-align:left;display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
        <div style="font-size:13px;font-weight:800;">${rec?fmt(rec.amount):fmt(u.rent)}</div>
        <button class="${toggleCls}" onclick="openPayEntry(${u.id},'${mk2}')">${toggleLbl}</button>
      </div>
    </div>`;
  }).join('');
}
function setPayFilter(f,btn){
  DB.payFilter=f;
  document.querySelectorAll('#pay-tabs .ftab').forEach(t=>t.classList.remove('on'));
  btn.classList.add('on');
  renderPayList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYMENT ENTRY MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPayEntry(uid,monthKey){
  DB.editPayUnit=uid; DB.editPayMonth=monthKey;
  const unit=DB.units.find(u=>u.id===uid),prop=DB.props.find(p=>p.id===unit.pid);
  const existing=DB.payments[uid]?.[monthKey],s=payStatus(unit,monthKey);

  document.getElementById('m-pay-unit-header').innerHTML=`
    <div style="display:flex;align-items:center;gap:10px;">
      ${unitIco(unit.type,40)}
      <div>
        <div style="font-size:14px;font-weight:800;">${unit.num}</div>
        <div style="font-size:12px;color:var(--muted);">${prop.name} Â· ${fmtMk(monthKey)} Â· ${fmt(unit.rent)}/Ø´Ù‡Ø±</div>
      </div>
    </div>`;

  const statuses=[
    {k:'paid',   l:'Ù…Ø¯ÙÙˆØ¹',    col:'var(--green)',  bg:'var(--green-lt)'},
    {k:'late',   l:'Ù…ØªØ£Ø®Ø±',   col:'var(--red)',    bg:'var(--red-lt)'},
    {k:'advance',l:'Ù…Ù‚Ø¯Ù‘Ù…',   col:'var(--purple)', bg:'var(--purple-lt)'},
    {k:'unpaid', l:'Ù„Ù… ÙŠÙØ¯ÙØ¹', col:'var(--muted)',  bg:'#F1F5F9'},
  ];
  let curSel=existing?(s==='advance'?'advance':'paid'):'unpaid';
  window._paySelStatus=curSel;

  document.getElementById('m-pay-status-btns').innerHTML=statuses.map(st=>`
    <button id="pst-${st.k}" onclick="selPayStatus('${st.k}')"
      style="border-radius:8px;padding:9px 12px;font-size:13px;font-weight:700;cursor:pointer;border:1.5px solid;font-family:inherit;transition:all .15s;text-align:center;
      background:${curSel===st.k?st.bg:'var(--surface)'};
      color:${curSel===st.k?st.col:'var(--muted)'};
      border-color:${curSel===st.k?st.col:'var(--border)'};">${st.l}</button>`).join('');

  document.getElementById('m-pay-amount').value=existing?.amount||unit.rent;
  document.getElementById('m-pay-note').value=existing?.note||'';
  openModal('m-pay-entry');
}
function selPayStatus(k){
  window._paySelStatus=k;
  const ss=[
    {k:'paid',  col:'var(--green)',  bg:'var(--green-lt)'},
    {k:'late',  col:'var(--red)',    bg:'var(--red-lt)'},
    {k:'advance',col:'var(--purple)',bg:'var(--purple-lt)'},
    {k:'unpaid',col:'var(--muted)',  bg:'#F1F5F9'},
  ];
  ss.forEach(st=>{
    const btn=document.getElementById('pst-'+st.k);
    if(!btn)return;
    const sel=st.k===k;
    btn.style.background=sel?st.bg:'var(--surface)';
    btn.style.color=sel?st.col:'var(--muted)';
    btn.style.borderColor=sel?st.col:'var(--border)';
  });
  if(k==='unpaid') document.getElementById('m-pay-amount').value='';
}
async function savePayEntry(){
  const uid=DB.editPayUnit,monthKey=DB.editPayMonth,status=window._paySelStatus;
  const amount=parseFloat(document.getElementById('m-pay-amount').value)||0;
  const note=document.getElementById('m-pay-note').value.trim();
  if(status==='unpaid'){
    await sbDeletePayment(uid,monthKey);
    if(DB.payments[uid]) delete DB.payments[uid][monthKey];
    toast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ù„Ù… ÙŠÙØ¯ÙØ¹');
  } else {
    if(!amount){toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº');return;}
    const rec={amount,note,paidAt:new Date().toISOString().slice(0,10)};
    await sbUpsertPayment(uid,monthKey,rec);
    if(!DB.payments[uid]) DB.payments[uid]={};
    DB.payments[uid][monthKey]=rec;
    const msgs={paid:'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©',late:'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©',advance:'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ù‚Ø¯Ù‘Ù…Ø©'};
    toast(msgs[status]||'ØªÙ… Ø§Ù„Ø­ÙØ¸');
  }
  closeModal('m-pay-entry');
  renderPayList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAINTENANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAINT_ST={
  open:     {l:'Ù…ÙØªÙˆØ­',bg:'var(--amber-lt)',c:'var(--amber)'},
  progress: {l:'Ø¬Ø§Ø±Ù', bg:'var(--blue-lt)', c:'var(--blue)'},
  done:     {l:'Ù…ØºÙ„Ù‚', bg:'var(--green-lt)',c:'var(--green)'},
};
function renderMaint(){
  const f=DB.maintFilter;
  const items=f==='all'?DB.maint:DB.maint.filter(x=>x.st===f);
  const open=DB.maint.filter(x=>x.st==='open').length;
  const prog=DB.maint.filter(x=>x.st==='progress').length;
  const done=DB.maint.filter(x=>x.st==='done').length;

  document.getElementById('maint-stats').innerHTML=`
    <div class="sbox" style="background:var(--amber-lt);">
      <div style="display:flex;justify-content:center;margin-bottom:4px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>
      <div class="snum" style="color:var(--amber);">${open}</div><div class="slbl">Ù…ÙØªÙˆØ­</div>
    </div>
    <div class="sbox" style="background:var(--blue-lt);">
      <div style="display:flex;justify-content:center;margin-bottom:4px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></div>
      <div class="snum" style="color:var(--blue);">${prog}</div><div class="slbl">Ø¬Ø§Ø±Ù</div>
    </div>
    <div class="sbox" style="background:var(--green-lt);">
      <div style="display:flex;justify-content:center;margin-bottom:4px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>
      <div class="snum" style="color:var(--green);">${done}</div><div class="slbl">Ù…ØºÙ„Ù‚</div>
    </div>`;

  document.getElementById('maint-list').innerHTML=items.length?items.map(m=>{
    const u=DB.units.find(x=>x.id===m.uid),p=DB.props.find(x=>x.id===m.pid),st=MAINT_ST[m.st];
    return `<div class="maint-row">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px;">
        <div style="display:flex;align-items:center;gap:6px;font-size:14px;font-weight:700;">
          ${MAINT_ICO[m.type]||SVG.wrench} ${m.type}
        </div>
        <div style="display:flex;align-items:center;gap:5px;">
          <span class="stag" style="background:${st.bg};color:${st.c};">${st.l}</span>
          <button onclick="openEditMaint(${m.id})" style="width:28px;height:28px;border-radius:7px;background:var(--blue-lt);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
          <button onclick="confirmDeleteMaint(${m.id})" style="width:28px;height:28px;border-radius:7px;background:var(--red-lt);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
          </button>
        </div>
      </div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:5px;">${u?.num||'â€”'} Â· ${p?.name||'â€”'}</div>
      <div style="font-size:13px;color:var(--ink);">${m.description}</div>
      <div style="display:flex;justify-content:space-between;margin-top:6px;">
        <div style="font-size:11px;color:var(--muted);">${m.dt}</div>
        <div style="font-size:13px;font-weight:800;">${m.cost?fmt(m.cost):'â€”'}</div>
      </div>
    </div>`;
  }).join(''):`<div style="padding:30px;text-align:center;color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>`;
}
async function cycleMaint(id){
  const m=DB.maint.find(x=>x.id===id);
  m.st={open:'progress',progress:'done',done:'open'}[m.st];
  await sbUpdateMaint(m);
  renderMaint();
  toast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: '+MAINT_ST[m.st].l);
}
function setMaintFilter(f,btn){
  DB.maintFilter=f;
  document.querySelectorAll('#v-maintenance .ftab').forEach(t=>t.classList.remove('on'));
  btn.classList.add('on');
  renderMaint();
}
function openAddMaintModal(){
  const sel=document.getElementById('maint-unit-sel');
  sel.innerHTML='<option value="">Ø§Ø®ØªØ±...</option>';
  DB.props.forEach(p=>{
    DB.units.filter(u=>u.pid===p.id).forEach(u=>{
      const o=document.createElement('option');
      o.value=JSON.stringify({uid:u.id,pid:p.id});
      o.textContent=`${u.num} â€” ${p.name}`;
      sel.appendChild(o);
    });
  });
  document.getElementById('maint-desc').value='';
  document.getElementById('maint-cost').value='';
  openModal('m-add-maint');
}
async function addMaint(){
  const sv=document.getElementById('maint-unit-sel').value;
  if(!sv){toast('Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©');return;}
  const{uid,pid}=JSON.parse(sv);
  const type=document.querySelector('#maint-type-grp .chip.on')?.dataset.v||'Ø£Ø®Ø±Ù‰';
  const desc=document.getElementById('maint-desc').value.trim();
  const cost=parseInt(document.getElementById('maint-cost').value)||0;
  const newM={uid,pid,type,description:desc||'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ',cost,st:'open',dt:new Date().toISOString().slice(0,10)};
  const savedM=await sbAddMaint(newM);
  if(!savedM) return;
  DB.maint.unshift({...savedM,uid:Number(savedM.uid),pid:Number(savedM.pid),cost:Number(savedM.cost)});
  closeModal('m-add-maint');
  renderMaint();
  toast('ØªÙ… Ø±ÙØ¹ Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderReports(){
  const mk2=DB.repMonth;
  document.getElementById('rep-month-lbl').textContent=fmtMk(mk2);

  // â”€â”€ Global summary â”€â”€
  let total=0,paid=0,late=0,adv=0,unpaid=0;
  DB.units.filter(u=>u.st==='rented').forEach(u=>{
    const s=payStatus(u,mk2),rec=DB.payments[u.id]?.[mk2];
    if(['paid','advance'].includes(s)){total+=rec?.amount||0; paid++;}
    if(s==='late')   late++;
    if(s==='unpaid') unpaid++;
    if(s==='advance') adv++;
  });
  const comm=Math.round(total*.05);

  document.getElementById('rep-summary').innerHTML=`
    <div style="font-size:15px;font-weight:800;margin-bottom:14px;display:flex;align-items:center;gap:8px;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.8)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Ù…Ù„Ø®Øµ ${fmtMk(mk2)}
    </div>
    <div class="rep-row"><div class="rep-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</div><div class="rep-val">${(+total||0).toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
    <div class="rep-row"><div class="rep-lbl">Ø¹Ù…ÙˆÙ„ØªÙŠ (5%)</div><div class="rep-val" style="color:#FBBF24;">${(+comm||0).toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
    <div class="rep-row"><div class="rep-lbl">ØµØ§ÙÙŠ Ù„Ù„Ù…Ù„Ø§Ùƒ</div><div class="rep-val" style="color:#34D399;">${((+total||0)-(+comm||0)).toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
    <div class="rep-row"><div class="rep-lbl">Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©</div><div class="rep-val" style="color:#FCA5A5;">${DB.maint.reduce((s,m)=>s+(m.cost||0),0).toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
    <div class="rep-row"><div class="rep-lbl">Ù…Ø¯ÙÙˆØ¹ ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯</div><div class="rep-val">${paid-adv} ÙˆØ­Ø¯Ø©</div></div>
    <div class="rep-row"><div class="rep-lbl">Ù…Ø¯ÙÙˆØ¹ Ù…Ù‚Ø¯Ù‘Ù…Ø§Ù‹</div><div class="rep-val" style="color:#A78BFA;">${adv} ÙˆØ­Ø¯Ø©</div></div>
    <div class="rep-row"><div class="rep-lbl">Ù…ØªØ£Ø®Ø± / Ù„Ù… ÙŠÙØ¯ÙØ¹</div><div class="rep-val" style="color:#F87171;">${late+unpaid} ÙˆØ­Ø¯Ø©</div></div>`;

  // â”€â”€ Per-property cards with unit rows â”€â”€
  document.getElementById('rep-props').innerHTML=DB.props.map(p=>{
    const allUnits=DB.units.filter(u=>u.pid===p.id);
    const rentedUnits=allUnits.filter(u=>u.st==='rented');
    const vacantUnits=allUnits.filter(u=>u.st==='vacant');

    let pT=0, pCollected=0, pLate=0, pAdv=0, pUnpaid=0;
    rentedUnits.forEach(u=>{
      const s=payStatus(u,mk2), rec=DB.payments[u.id]?.[mk2];
      if(['paid','advance'].includes(s)){ pT+=rec?.amount||0; pCollected++; }
      if(s==='late')   pLate++;
      if(s==='unpaid') pUnpaid++;
      if(s==='advance') pAdv++;
    });
    const pC=Math.round(pT*.05);
    const hasIssue=pLate>0||pUnpaid>0;

    // Unit rows
    const unitRows=allUnits.map(u=>{
      if(u.st==='vacant'){
        return `<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);">
          ${unitIco(u.type,34)}
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;">${u.num}</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px;">${tm(u.type).l}</div>
          </div>
          <span class="stag" style="background:#F1F5F9;color:var(--muted);">ÙØ§Ø¶ÙŠØ©</span>
          <div style="font-size:13px;font-weight:700;color:var(--muted);min-width:60px;text-align:left;">â€”</div>
        </div>`;
      }
      // rented
      const s=payStatus(u,mk2);
      const rec=DB.payments[u.id]?.[mk2];
      const SM={
        paid:    {label:'Ù…Ø¯ÙÙˆØ¹',   style:`background:var(--green-lt);color:var(--green)`},
        advance: {label:'Ù…Ù‚Ø¯Ù‘Ù…',   style:`background:var(--purple-lt);color:var(--purple)`},
        late:    {label:'Ù…ØªØ£Ø®Ø±',  style:`background:var(--red-lt);color:var(--red)`},
        unpaid:  {label:'Ù„Ù… ÙŠÙØ¯ÙØ¹',style:`background:var(--blue-lt);color:var(--blue)`},
      };
      const sm=SM[s]||SM.unpaid;
      const amtTxt=rec?fmt(rec.amount):`${fmt(u.rent)} Ù…ØªÙˆÙ‚Ø¹`;
      const noteHtml=rec?.note?`<div style="font-size:10px;color:var(--muted);margin-top:1px;">ğŸ“ ${rec.note}</div>`:'';
      return `<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);">
        ${unitIco(u.type,34)}
        <div style="flex:1;">
          <div style="font-size:13px;font-weight:700;">${u.num}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:1px;">${tm(u.type).l}${rec?.paidAt?` Â· ${rec.paidAt}`:''}</div>
          ${noteHtml}
        </div>
        <div style="text-align:left;">
          <span class="stag" style="${sm.style};margin-bottom:4px;display:inline-block;">${sm.label}</span>
          <div style="font-size:12px;font-weight:800;color:${['paid','advance'].includes(s)?'var(--green)':s==='late'?'var(--red)':'var(--muted)'};">${amtTxt}</div>
        </div>
      </div>`;
    }).join('');

    return `<div style="background:var(--surface);border:2px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06);">

      <!-- Blue header -->
      <div style="background:var(--blue);padding:14px 16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div>
            <div style="font-size:15px;font-weight:800;color:#fff;">${p.name}</div>
            <div style="font-size:11px;color:rgba(255,255,255,.75);margin-top:2px;">${p.owner} Â· ${p.loc}</div>
          </div>
          <span class="stag" style="${hasIssue?'background:rgba(220,38,38,.3);color:#FCA5A5':'background:rgba(255,255,255,.2);color:#fff'};">
            ${hasIssue?`${pLate+pUnpaid} ØºÙŠØ± Ù…ÙƒØªÙ…Ù„`:'Ù…ÙƒØªÙ…Ù„'}
          </span>
        </div>
        <div style="display:flex;gap:6px;">
          <div style="flex:1;background:rgba(255,255,255,.15);border-radius:8px;padding:9px;text-align:center;">
            <div style="font-size:13px;font-weight:800;color:#fff;">${(+pT||0).toLocaleString('ar-SA')} Ø±</div>
            <div style="font-size:9px;color:rgba(255,255,255,.75);margin-top:2px;">ØªØ­ØµÙŠÙ„</div>
          </div>
          <div style="flex:1;background:rgba(255,255,255,.15);border-radius:8px;padding:9px;text-align:center;">
            <div style="font-size:13px;font-weight:800;color:#FBBF24;">${(+pC||0).toLocaleString('ar-SA')} Ø±</div>
            <div style="font-size:9px;color:rgba(255,255,255,.75);margin-top:2px;">Ø¹Ù…ÙˆÙ„ØªÙŠ</div>
          </div>
          <div style="flex:1;background:rgba(255,255,255,.15);border-radius:8px;padding:9px;text-align:center;">
            <div style="font-size:13px;font-weight:800;color:#34D399;">${((+pT||0)-(+pC||0)).toLocaleString('ar-SA')} Ø±</div>
            <div style="font-size:9px;color:rgba(255,255,255,.75);margin-top:2px;">Ù„Ù„Ù…Ø§Ù„Ùƒ</div>
          </div>
        </div>
      </div>

      <!-- Counts bar -->
      <div style="background:var(--paper);padding:7px 14px;font-size:11px;display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid var(--border);">
        <span style="color:var(--muted);">${allUnits.length} ÙˆØ­Ø¯Ø©</span>
        <span style="color:var(--green);font-weight:700;">âœ“ ${pCollected} Ù…Ø¯ÙÙˆØ¹Ø©</span>
        ${pLate>0?`<span style="color:var(--red);font-weight:700;">âš  ${pLate} Ù…ØªØ£Ø®Ø±Ø©</span>`:''}
        ${pUnpaid>0?`<span style="color:var(--blue);font-weight:700;">${pUnpaid} Ù„Ù… ØªÙØ¯ÙØ¹</span>`:''}
        ${vacantUnits.length>0?`<span style="color:var(--muted);">${vacantUnits.length} ÙØ§Ø¶ÙŠØ©</span>`:''}
      </div>

      <!-- Section label -->
      <div style="background:var(--paper);padding:5px 14px;font-size:10px;font-weight:700;color:var(--muted);letter-spacing:.5px;border-bottom:1px solid var(--border);">
        ØªÙØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
      </div>

      <!-- Unit rows -->
      <div style="background:var(--surface);">${unitRows}</div>

    </div>`;
  }).join('');
}
function shiftRepMonth(dir){
  DB.repMonth=dir<0?prevMk(DB.repMonth):nextMk(DB.repMonth);
  renderReports();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAINTENANCE EDIT / DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _editMaintId=null;
function openEditMaint(id){
  const m=DB.maint.find(x=>x.id===id);
  _editMaintId=id;
  document.querySelectorAll('#edit-maint-type-grp .chip').forEach(c=>c.classList.toggle('on',c.dataset.v===m.type));
  document.querySelectorAll('#edit-maint-st-grp .chip').forEach(c=>c.classList.toggle('on',c.dataset.v===m.st));
  document.getElementById('edit-maint-desc').value=m.descriptionription;
  document.getElementById('edit-maint-cost').value=m.cost||'';
  openModal('m-edit-maint');
}
async function saveEditMaint(){
  const m=DB.maint.find(x=>x.id===_editMaintId);
  if(!m) return;
  m.type=document.querySelector('#edit-maint-type-grp .chip.on')?.dataset.v||m.type;
  m.st=document.querySelector('#edit-maint-st-grp .chip.on')?.dataset.v||m.st;
  m.description=document.getElementById('edit-maint-desc').value.trim()||m.description;
  m.cost=parseInt(document.getElementById('edit-maint-cost').value)||0;
  await sbUpdateMaint(m);
  closeModal('m-edit-maint');
  renderMaint();
  toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');
}
function confirmDeleteMaint(id){
  const m=DB.maint.find(x=>x.id===id);
  document.getElementById('m-confirm-title').textContent='Ø­Ø°Ù Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø©';
  document.getElementById('m-confirm-body').textContent=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø·Ù„Ø¨ "${m.type}: ${m.description}"ØŸ`;
  document.getElementById('m-confirm-ok').onclick=()=>deleteMaint(id);
  openModal('m-confirm');
}
async function deleteMaint(id){
  await sbDeleteMaint(id);
  DB.maint=DB.maint.filter(x=>x.id!==id);
  closeModal('m-confirm');
  renderMaint();
  toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARE REPORT AS PDF (A4)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shareReport(){
  const mk2=DB.repMonth;
  let total=0,paid=0,late=0,adv=0,unpaid=0;
  DB.units.filter(u=>u.st==='rented').forEach(u=>{
    const s=payStatus(u,mk2),rec=DB.payments[u.id]?.[mk2];
    if(['paid','advance'].includes(s)){total+=rec?.amount||0;paid++;}
    if(s==='late') late++;
    if(s==='unpaid') unpaid++;
    if(s==='advance') adv++;
  });
  const comm=Math.round(total*.05);
  const maintCost=DB.maint.reduce((s,m)=>s+(m.cost||0),0);

  const propRows=DB.props.map(p=>{
    const allU=DB.units.filter(u=>u.pid===p.id);
    const rentedU=allU.filter(u=>u.st==='rented');
    const propMaint=DB.maint.filter(m=>m.pid===p.id);
    const propMaintCost=propMaint.reduce((s,m)=>s+(m.cost||0),0);
    let pT=0,pColl=0,pLate=0,pUnpaid=0;
    rentedU.forEach(u=>{
      const s=payStatus(u,mk2),rec=DB.payments[u.id]?.[mk2];
      if(['paid','advance'].includes(s)){pT+=rec?.amount||0;pColl++;}
      if(s==='late') pLate++;
      if(s==='unpaid') pUnpaid++;
    });
    const pC=Math.round(pT*.05);
    const statusBadge=pLate+pUnpaid>0
      ?`<span style="background:#FEF2F2;color:#DC2626;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;">${pLate+pUnpaid} ØºÙŠØ± Ù…ÙƒØªÙ…Ù„</span>`
      :`<span style="background:#ECFDF5;color:#059669;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;">Ù…ÙƒØªÙ…Ù„</span>`;
    const unitRows=allU.map(u=>{
      const s=u.st==='vacant'?'vacant':payStatus(u,mk2);
      const stLabel={paid:'âœ“ Ù…Ø¯ÙÙˆØ¹',advance:'Ù…Ù‚Ø¯Ù‘Ù…',late:'Ù…ØªØ£Ø®Ø±',unpaid:'Ù„Ù… ÙŠÙØ¯ÙØ¹',vacant:'ÙØ§Ø¶ÙŠØ©'}[s]||s;
      const stColor={paid:'#059669',advance:'#7C3AED',late:'#DC2626',unpaid:'#2563EB',vacant:'#94A3B8'}[s]||'#94A3B8';
      const rec=DB.payments[u.id]?.[mk2];
      const amt=u.st==='vacant'?'â€”':rec?`${rec.amount.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„`:`${u.rent.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„ (Ù…ØªÙˆÙ‚Ø¹)`;
      const bg=s==='paid'?'#F0FDF4':s==='late'?'#FFF5F5':s==='unpaid'?'#EFF6FF':'#FAFAFA';
      // Maintenance rows for this unit
      const uMaint=DB.maint.filter(m=>m.uid===u.id);
      const maintRows=uMaint.map(m=>{
        const stMLabel={open:'Ù…ÙØªÙˆØ­',progress:'Ø¬Ø§Ø±Ù',done:'Ù…ØºÙ„Ù‚'}[m.st]||m.st;
        const stMColor={open:'#D97706',progress:'#2563EB',done:'#059669'}[m.st]||'#64748B';
        return `<tr style="background:#FFFBEB;">
          <td style="padding:5px 12px 5px 24px;font-size:11px;color:#92400E;border-bottom:1px solid #FEF3C7;" colspan="2">ğŸ”§ ${m.type}: ${m.description}</td>
          <td style="padding:5px 12px;font-size:11px;font-weight:700;color:${stMColor};border-bottom:1px solid #FEF3C7;">${stMLabel}</td>
          <td style="padding:5px 12px;font-size:11px;font-weight:800;color:#D97706;text-align:left;border-bottom:1px solid #FEF3C7;">${m.cost?m.cost.toLocaleString('ar-SA')+' Ø±ÙŠØ§Ù„':'â€”'}</td>
        </tr>`;
      }).join('');
      return `<tr style="background:${bg};">
        <td style="padding:7px 12px;font-size:12px;border-bottom:1px solid #F1F5F9;">${u.num}</td>
        <td style="padding:7px 12px;font-size:11px;border-bottom:1px solid #F1F5F9;">${{apt:'Ø´Ù‚Ø©',villa:'ÙÙŠÙ„Ø§',shop:'Ù…Ø­Ù„',office:'Ù…ÙƒØªØ¨'}[u.type]||u.type}</td>
        <td style="padding:7px 12px;font-size:11px;font-weight:700;color:${stColor};border-bottom:1px solid #F1F5F9;">${stLabel}</td>
        <td style="padding:7px 12px;font-size:12px;font-weight:700;border-bottom:1px solid #F1F5F9;text-align:left;">${amt}</td>
      </tr>${maintRows}`;
    }).join('');
    const maintSummary=propMaintCost>0?`
      <tr style="background:#FFF7ED;"><td colspan="4" style="padding:7px 16px;font-size:11px;font-weight:800;color:#92400E;border-top:2px solid #FED7AA;">ğŸ“‹ Ù…Ù„Ø®Øµ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©</td></tr>
      ${propMaint.map(m=>{
        const u2=allU.find(x=>x.id===m.uid);
        const stMLabel={open:'Ù…ÙØªÙˆØ­',progress:'Ø¬Ø§Ø±Ù',done:'Ù…ØºÙ„Ù‚'}[m.st]||m.st;
        return `<tr style="background:#FFF7ED;"><td style="padding:5px 16px;font-size:11px;color:#92400E;" colspan="2">${u2?.num||'â€”'} â† ${m.type}: ${m.description}</td><td style="padding:5px 12px;font-size:11px;font-weight:700;color:#059669;">${stMLabel}</td><td style="padding:5px 12px;font-size:11px;font-weight:800;color:#D97706;text-align:left;">${m.cost?m.cost.toLocaleString('ar-SA')+' Ø±ÙŠØ§Ù„':'â€”'}</td></tr>`;
      }).join('')}
      <tr style="background:#FEF3C7;"><td colspan="3" style="padding:8px 16px;font-size:12px;font-weight:800;color:#92400E;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td><td style="padding:8px 12px;font-size:13px;font-weight:800;color:#D97706;text-align:left;">${propMaintCost.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</td></tr>`
    :'';
    return `<div style="margin-bottom:24px;border:1px solid #E2E8F0;border-radius:10px;overflow:hidden;page-break-inside:avoid;">
      <div style="background:#2563EB;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-size:15px;font-weight:800;">${p.name}</div>
          <div style="font-size:11px;opacity:.8;margin-top:2px;">${p.owner} Â· ${p.loc}</div>
        </div>
        <div style="text-align:left;">
          <div style="font-size:17px;font-weight:800;">${pT.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div>
          ${statusBadge}
        </div>
      </div>
      <table style="width:100%;border-collapse:collapse;">
        <thead><tr style="background:#F8FAFC;">
          <th style="padding:7px 12px;font-size:11px;color:#64748B;font-weight:600;text-align:right;border-bottom:1px solid #E2E8F0;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
          <th style="padding:7px 12px;font-size:11px;color:#64748B;font-weight:600;text-align:right;border-bottom:1px solid #E2E8F0;">Ø§Ù„Ù†ÙˆØ¹</th>
          <th style="padding:7px 12px;font-size:11px;color:#64748B;font-weight:600;text-align:right;border-bottom:1px solid #E2E8F0;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th style="padding:7px 12px;font-size:11px;color:#64748B;font-weight:600;text-align:left;border-bottom:1px solid #E2E8F0;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
        </tr></thead>
        <tbody>${unitRows}${maintSummary}</tbody>
      </table>
      <div style="background:#F8FAFC;padding:8px 16px;display:flex;gap:16px;flex-wrap:wrap;border-top:1px solid #E2E8F0;">
        <span style="font-size:11px;color:#64748B;">Ø¹Ù…ÙˆÙ„ØªÙŠ: <strong style="color:#D97706;">${pC.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</strong></span>
        <span style="font-size:11px;color:#64748B;">ØµØ§ÙÙŠ Ø§Ù„Ù…Ø§Ù„Ùƒ: <strong style="color:#059669;">${(pT-pC).toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</strong></span>
        <span style="font-size:11px;color:#64748B;">Ù…Ø¯ÙÙˆØ¹: <strong>${pColl}/${rentedU.length}</strong></span>
        ${propMaintCost>0?`<span style="font-size:11px;color:#64748B;">ØµÙŠØ§Ù†Ø©: <strong style="color:#D97706;">${propMaintCost.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</strong></span>`:''}
      </div>
    </div>`;
  }).join('');

  const html=`<!DOCTYPE html><html lang="ar" dir="rtl"><head>
  <meta charset="UTF-8">
  <title>ØªÙ‚Ø±ÙŠØ± PropFlow â€” ${fmtMk(mk2)}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700;800&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'IBM Plex Sans Arabic',Arial,sans-serif;direction:rtl;background:#fff;color:#0F172A;padding:28px;}
    @page{size:A4;margin:16mm 14mm;}
    @media print{body{padding:0;}}
  </style></head><body>
  <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:20px;padding-bottom:14px;border-bottom:3px solid #2563EB;">
    <div>
      <div style="font-size:28px;font-weight:800;color:#2563EB;">PropFlow</div>
      <div style="font-size:13px;color:#64748B;margin-top:3px;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø´Ù‡Ø±ÙŠ Â· ${fmtMk(mk2)}</div>
    </div>
    <div style="text-align:left;font-size:11px;color:#94A3B8;">${new Date().toLocaleDateString('ar-SA')}</div>
  </div>
  <div style="background:#2563EB;color:#fff;border-radius:12px;padding:18px;margin-bottom:24px;">
    <div style="font-size:14px;font-weight:800;margin-bottom:14px;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;">
      <div><div style="font-size:11px;opacity:.8;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</div><div style="font-size:18px;font-weight:800;margin-top:3px;">${total.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
      <div><div style="font-size:11px;opacity:.8;">Ø¹Ù…ÙˆÙ„ØªÙŠ (5%)</div><div style="font-size:18px;font-weight:800;color:#FBBF24;margin-top:3px;">${comm.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
      <div><div style="font-size:11px;opacity:.8;">ØµØ§ÙÙŠ Ù„Ù„Ù…Ù„Ø§Ùƒ</div><div style="font-size:18px;font-weight:800;color:#34D399;margin-top:3px;">${(total-comm).toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
      <div><div style="font-size:11px;opacity:.8;">Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©</div><div style="font-size:18px;font-weight:800;color:#FCA5A5;margin-top:3px;">${maintCost.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
    </div>
    <div style="border-top:1px solid rgba(255,255,255,.2);margin-top:14px;padding-top:10px;display:flex;gap:20px;font-size:12px;opacity:.9;">
      <span>Ù…Ø¯ÙÙˆØ¹: <strong>${paid} ÙˆØ­Ø¯Ø©</strong></span>
      <span>Ù…ØªØ£Ø®Ø±: <strong style="color:#FCA5A5;">${late} ÙˆØ­Ø¯Ø©</strong></span>
      <span>Ù„Ù… ÙŠÙØ¯ÙØ¹: <strong style="color:#93C5FD;">${unpaid} ÙˆØ­Ø¯Ø©</strong></span>
      <span>Ù…Ù‚Ø¯Ù‘Ù…: <strong style="color:#C4B5FD;">${adv} ÙˆØ­Ø¯Ø©</strong></span>
    </div>
  </div>
  <div style="font-size:16px;font-weight:800;margin-bottom:16px;color:#0F172A;">ØªÙ‚Ø±ÙŠØ± ÙƒÙ„ Ø¹Ù‚Ø§Ø±</div>
  ${propRows}
  <div style="margin-top:20px;padding-top:12px;border-top:1px solid #E2E8F0;font-size:10px;color:#94A3B8;text-align:center;">
    ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© PropFlow Â· ${new Date().toLocaleString('ar-SA')}
  </div>
  <script>window.onload=function(){window.print();}<\/script>
  </body></html>`;

  // Show report in-app print view
  // Build display-friendly version (no html/head wrapper needed since we inject into div)
  const displayHtml = `
  <div style="font-family:'IBM Plex Sans Arabic',Arial,sans-serif;direction:rtl;padding:16px;background:#fff;min-height:100%;">
    <!-- Header -->
    <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:20px;padding-bottom:12px;border-bottom:3px solid #2563EB;">
      <div>
        <div style="font-size:22px;font-weight:800;color:#2563EB;">PropFlow</div>
        <div style="font-size:12px;color:#64748B;margin-top:3px;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­ØµÙŠÙ„ Â· ${fmtMk(mk2)}</div>
      </div>
      <div style="font-size:11px;color:#94A3B8;">${new Date().toLocaleDateString('ar-SA')}</div>
    </div>
    <!-- Summary -->
    <div style="background:#2563EB;color:#fff;border-radius:12px;padding:16px;margin-bottom:20px;">
      <div style="font-size:13px;font-weight:800;margin-bottom:12px;">Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div><div style="font-size:10px;opacity:.8;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</div><div style="font-size:17px;font-weight:800;margin-top:2px;">${total.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
        <div><div style="font-size:10px;opacity:.8;">Ø¹Ù…ÙˆÙ„ØªÙŠ (5%)</div><div style="font-size:17px;font-weight:800;color:#FBBF24;margin-top:2px;">${comm.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
        <div><div style="font-size:10px;opacity:.8;">ØµØ§ÙÙŠ Ù„Ù„Ù…Ù„Ø§Ùƒ</div><div style="font-size:17px;font-weight:800;color:#34D399;margin-top:2px;">${(total-comm).toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
        <div><div style="font-size:10px;opacity:.8;">Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©</div><div style="font-size:17px;font-weight:800;color:#FCA5A5;margin-top:2px;">${maintCost.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</div></div>
      </div>
      <div style="border-top:1px solid rgba(255,255,255,.2);margin-top:12px;padding-top:8px;display:flex;gap:14px;font-size:11px;flex-wrap:wrap;">
        <span>Ù…Ø¯ÙÙˆØ¹: <strong>${paid} ÙˆØ­Ø¯Ø©</strong></span>
        <span>Ù…ØªØ£Ø®Ø±: <strong style="color:#FCA5A5;">${late}</strong></span>
        <span>Ù„Ù… ÙŠÙØ¯ÙØ¹: <strong style="color:#93C5FD;">${unpaid}</strong></span>
      </div>
    </div>
    <!-- Per-property -->
    <div style="font-size:14px;font-weight:800;margin-bottom:12px;">ØªÙ‚Ø±ÙŠØ± ÙƒÙ„ Ø¹Ù‚Ø§Ø±</div>
    ${propRows}
    <div style="margin-top:16px;font-size:10px;color:#94A3B8;text-align:center;padding-top:10px;border-top:1px solid #E2E8F0;">
      PropFlow Â· ${new Date().toLocaleString('ar-SA')}
    </div>
  </div>`;

  // Store for printing
  window._reportHtml = html;
  document.getElementById('report-preview-content').innerHTML=displayHtml;
  document.getElementById('v-report-preview').classList.remove('hidden');
  document.getElementById('v-report-preview').scrollTop=0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function printReport(){
  const html=window._reportHtml||'';
  if(!html){toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ±');return;}
  const w=window.open('','_blank');
  if(w){
    w.document.write(html);
    w.document.close();
    setTimeout(()=>w.print(),600);
  } else {
    // fallback: write to current window print
    const orig=document.body.innerHTML;
    document.body.innerHTML=`<div style="direction:rtl;">${html}</div>`;
    window.print();
    document.body.innerHTML=orig;
    location.reload();
  }
}

function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function closeOverlay(id,ev){ if(ev.target.classList.contains('overlay')) closeModal(id); }
function chipSel(el,grp){ document.querySelectorAll('#'+grp+' .chip').forEach(c=>c.classList.remove('on')); el.classList.add('on'); }
function toast(msg){
  const el=document.getElementById('toastEl');
  el.textContent=msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),2400);
}
async function addProperty(){
  const name=document.getElementById('np-name').value.trim();
  const owner=document.getElementById('np-owner').value.trim();
  const loc=document.getElementById('np-loc').value.trim();
  if(!name){toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±');return;}
  if(!owner){toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ');return;}
  const saved=await sbAddProp({name,owner,loc:loc||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'});
  if(!saved) return;
  DB.props.push({...saved});
  closeModal('m-add-prop');
  renderProps();
  toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© '+name);
}

// INIT
sbLoad().then(()=>{ renderHome(); renderProps(); renderPayments(); renderMaint(); renderReports(); go('home'); });
</script>
</body>
</html>
